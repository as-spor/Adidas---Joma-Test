<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>As Spor - Showroom Sistemi</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <link rel="apple-touch-icon" href="icon-192.png">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root { --primary: #000000; --accent: #00AEEF; --bg: #f8f9fb; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding-bottom: 120px; color: #1a1a1a; }

        /* STATUS BAR */
        #debugStatus {
            background: #f39c12; color: white; padding: 10px;
            text-align: center; font-weight: bold; font-size: 14px;
            position: fixed; top: 0; left: 0; width: 100%; z-index: 9999;
            transition: background 0.4s;
        }

        /* LOGIN */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--primary); z-index: 5000;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center; padding: 20px;
            transition: opacity 0.3s;
        }
        .login-box {
            background: white; width: 100%; max-width: 350px;
            padding: 40px 30px; border-radius: 24px; text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
        }
        .login-input {
            width: 100%; padding: 15px; margin: 10px 0;
            border: 2px solid #eee; border-radius: 12px;
            outline: none; font-family: 'Inter'; font-size: 16px;
        }
        .login-input:focus { border-color: var(--accent); }
        .login-btn {
            width: 100%; background: var(--accent); color: white;
            padding: 15px; border: none; border-radius: 12px;
            font-weight: 800; cursor: pointer; margin-top: 10px; font-size: 16px;
        }
        .error-msg {
            color: #ff4d4d; font-size: 14px; font-weight: 600;
            margin-top: 15px; display: none;
            padding: 10px; background: #fff0f0; border-radius: 8px;
        }

        /* LAYOUT */
        .header-hero {
            background: var(--primary); color: white;
            padding: 50px 20px 80px; border-bottom: 6px solid var(--accent);
        }
        .main-container { max-width: 1200px; margin: 0 auto; padding: 0 15px; }
        .user-welcome-bar {
            background: white; padding: 15px 20px; border-radius: 18px;
            margin-top: -50px; box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            display: flex; flex-wrap: wrap; align-items: center;
            justify-content: space-between; gap: 10px;
        }

        /* SEARCH */
        .search-container {
            background: white; padding: 8px; border-radius: 18px;
            margin-top: 20px; display: flex; gap: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
        }
        .search-field {
            flex: 1; border: none; padding-left: 15px;
            outline: none; font-size: 16px; font-family: 'Inter';
        }
        .btn-scan {
            background: var(--primary); color: white; border: none;
            width: 55px; height: 50px; border-radius: 14px; cursor: pointer; font-size: 18px;
        }
        .btn-camera {
            background: var(--accent); color: white; border: none;
            width: 55px; height: 50px; border-radius: 14px; cursor: pointer; font-size: 20px;
        }

        /* SCANNER PANEL */
        #reader-container {
            width: 100%; margin-top: 15px; display: none;
            background: #111; border-radius: 22px; overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.35);
        }
        .scanner-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 16px; background: #000;
        }
        .scanner-header span { color: #fff; font-weight: 700; font-size: 14px; }
        .scanner-mode-tabs { display: flex; gap: 6px; }
        .mode-tab {
            padding: 5px 13px; border-radius: 20px; font-size: 12px;
            font-weight: 700; border: none; cursor: pointer;
            background: #333; color: #aaa; transition: 0.2s;
        }
        .mode-tab.active { background: var(--accent); color: #fff; }

        #reader-viewport {
            position: relative; width: 100%; height: 220px;
            overflow: hidden; background: #000;
        }
        #reader { width: 100% !important; height: 220px !important; }
        #reader video { width: 100% !important; height: 220px !important; object-fit: cover; }
        #reader__dashboard, #reader__status_span, #reader button,
        #reader select, #reader__header_message,
        #reader__scan_region img { display: none !important; }

        .scanner-overlay-top, .scanner-overlay-bottom {
            position: absolute; left: 0; width: 100%;
            background: rgba(0,0,0,0.55); pointer-events: none; z-index: 5;
        }
        .scanner-overlay-top    { top: 0;    height: 72px; }
        .scanner-overlay-bottom { bottom: 0; height: 72px; }

        .scan-frame {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 240px; height: 56px; z-index: 8; pointer-events: none;
        }
        .scan-frame::before, .scan-frame::after,
        .scan-frame span::before, .scan-frame span::after {
            content: ''; position: absolute; width: 18px; height: 18px;
            border-color: var(--accent); border-style: solid;
        }
        .scan-frame::before      { top:0;    left:0;  border-width:3px 0 0 3px; border-radius:4px 0 0 0; }
        .scan-frame::after       { top:0;    right:0; border-width:3px 3px 0 0; border-radius:0 4px 0 0; }
        .scan-frame span::before { bottom:0; left:0;  border-width:0 0 3px 3px; border-radius:0 0 0 4px; }
        .scan-frame span::after  { bottom:0; right:0; border-width:0 3px 3px 0; border-radius:0 0 4px 0; }

        .scanner-laser {
            position: absolute; left: calc(50% - 120px); width: 240px; height: 2px;
            background: linear-gradient(90deg, transparent, #ff3333, #ff6666, #ff3333, transparent);
            box-shadow: 0 0 8px 1px rgba(255,50,50,0.7);
            z-index: 9; pointer-events: none;
            animation: laserSweep 1.6s infinite ease-in-out;
        }
        @keyframes laserSweep {
            0%   { top: calc(50% - 28px); }
            50%  { top: calc(50% + 26px); }
            100% { top: calc(50% - 28px); }
        }
        .scan-hint {
            position: absolute; bottom: 8px; width: 100%;
            text-align: center; color: rgba(255,255,255,0.75);
            font-size: 11px; font-weight: 600; z-index: 9; pointer-events: none;
        }

        .ocr-controls { display: flex; border-top: 1px solid #222; }
        .btn-ocr-trigger {
            flex: 1; background: var(--accent); color: white; border: none;
            padding: 15px 10px; font-weight: 800; cursor: pointer;
            font-size: 13px; text-transform: uppercase; letter-spacing: 0.8px;
            display: none; align-items: center; justify-content: center; gap: 6px;
        }
        .btn-close-camera {
            flex: 1; background: #222; color: #ccc; border: none;
            padding: 15px 18px; font-weight: 700; cursor: pointer; font-size: 13px;
        }

        /* PRODUCT CARDS */
        #resultsArea {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(160px,1fr));
            gap: 14px; margin-top: 25px; padding-bottom: 100px;
        }
        @media(max-width:480px){ #resultsArea { grid-template-columns: repeat(2,1fr); } }

        .product-card {
            background: white; border-radius: 16px; overflow: hidden;
            box-shadow: 0 3px 12px rgba(0,0,0,0.07); border: 1.5px solid #eee;
            display: flex; flex-direction: column; cursor: pointer;
            transition: transform 0.18s, box-shadow 0.18s;
            animation: fadeUp 0.35s ease both;
        }
        .product-card:active { transform: scale(0.97); }
        @keyframes fadeUp { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:none} }

        /* Compact card image */
        .product-img {
            width:100%; height:140px; object-fit:contain;
            background:#fafafa; padding:8px;
        }
        /* Compact card info */
        .product-info-wrapper { padding:10px 12px 12px; flex-grow:1; display:flex; flex-direction:column; }
        .product-code-label { font-size:11px; color:#bbb; font-weight:600; letter-spacing:0.3px; margin:0; }
        .product-name-label { font-size:12px; font-weight:700; color:#222; margin:3px 0 0; line-height:1.3;
            display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
        .price-tag { font-size:15px; font-weight:800; color:var(--accent); margin:6px 0 0; display:block; }

        /* ‚îÄ‚îÄ PRODUCT DETAIL MODAL ‚îÄ‚îÄ */
        #productModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.75); z-index:6500;
            align-items:flex-end; justify-content:center; }
        #productModal.open { display:flex; }
        #productModalBox {
            background:white; width:100%; max-width:560px; border-radius:28px 28px 0 0;
            padding:0 0 30px; max-height:90vh; overflow-y:auto;
            animation: slideUp 0.28s ease;
        }
        @keyframes slideUp { from{transform:translateY(60px);opacity:0} to{transform:none;opacity:1} }
        #productModalImg {
            width:100%; height:240px; object-fit:contain;
            background:#f5f5f5; border-radius:28px 28px 0 0; padding:16px;
        }
        .pm-body { padding:20px 22px 0; }
        .pm-code { font-size:12px; color:#aaa; font-weight:600; }
        .pm-name { font-size:18px; font-weight:800; margin:4px 0 2px; }
        .pm-ean  { font-size:12px; color:#aaa; margin:0 0 6px; }
        .pm-price{ font-size:24px; font-weight:800; color:var(--accent); margin:0 0 16px; }
        .pm-sizes-title { font-size:13px; font-weight:700; color:#555; margin-bottom:8px; }
        .pm-size-row {
            display:flex; justify-content:space-between; align-items:center;
            padding:10px 0; border-bottom:1px solid #f2f2f2;
        }
        .pm-size-label { font-size:14px; font-weight:600; }
        .pm-stock-label { font-size:12px; color:#aaa; }
        .pm-qty-ctrl { display:flex; gap:6px; align-items:center; }
        .pm-btn-qty {
            width:34px; height:34px; border-radius:10px; border:none;
            font-weight:800; font-size:18px; cursor:pointer; background:#f0f0f0; line-height:1;
        }
        .pm-qty-inp {
            width:48px; text-align:center; border:1.5px solid #ddd;
            border-radius:10px; height:34px; font-weight:700; font-size:15px;
        }
        .pm-add-btn {
            width:100%; background:#000; color:white; border:none;
            padding:16px; border-radius:14px; margin-top:18px;
            font-weight:800; font-size:15px; cursor:pointer; letter-spacing:0.5px;
        }
        .pm-close-btn {
            position:absolute; top:14px; right:18px;
            background:rgba(0,0,0,0.12); border:none; border-radius:50%;
            width:34px; height:34px; font-size:20px; cursor:pointer;
            display:flex; align-items:center; justify-content:center; color:#333;
        }
        #productModal { position: fixed; }
        #productModalBox { position: relative; }

        /* ‚îÄ‚îÄ STICKY CART BAR ‚îÄ‚îÄ */
        #cartBar {
            position:fixed; bottom:0; left:0; right:0;
            background:#000; color:white;
            display:none; /* shown when cart has items */
            align-items:center; justify-content:space-between;
            padding:14px 20px; z-index:2000;
            box-shadow:0 -4px 20px rgba(0,0,0,0.18);
        }
        #cartBar.visible { display:flex; }
        .cart-bar-left { display:flex; flex-direction:column; }
        .cart-bar-count { font-size:12px; color:#aaa; font-weight:600; }
        .cart-bar-total { font-size:20px; font-weight:800; color:var(--accent); line-height:1.1; }
        .cart-bar-btn {
            background:var(--accent); color:white; border:none;
            padding:12px 22px; border-radius:14px; font-weight:800;
            font-size:14px; cursor:pointer; white-space:nowrap;
        }

        /* floating cart button rides above the bar */
        .floating-cart {
            position:fixed; bottom:80px; right:20px;
            background:var(--accent); color:white; width:58px; height:58px;
            border-radius:50%; display:flex; justify-content:center; align-items:center;
            box-shadow:0 8px 20px rgba(0,174,239,0.4); z-index:2001; cursor:pointer;
        }
        .cart-badge {
            position:absolute; top:-4px; right:-4px;
            background:#ff4d4d; color:white; border-radius:50%;
            width:22px; height:22px; font-size:11px;
            display:flex; justify-content:center; align-items:center;
            border:2px solid white; font-weight:800;
        }

        /* Cart modal size editor */
        .cart-size-row {
            display:flex; justify-content:space-between; align-items:center;
            padding:10px 0; border-bottom:1px solid #f0f0f0;
        }
        .cart-size-info { font-size:13px; }
        .cart-size-info b { display:block; }
        .cart-size-info small { color:#aaa; }
        .cart-qty-ctrl { display:flex; gap:5px; align-items:center; }
        .cart-btn-qty { width:30px; height:30px; border-radius:8px; border:none;
            font-weight:800; font-size:16px; cursor:pointer; background:#f0f0f0; }
        .cart-qty-val { width:40px; text-align:center; font-weight:700; font-size:14px;
            border:1.5px solid #ddd; border-radius:8px; height:30px; }

        /* MODALS */
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:6000; }
        .modal-content { background:white; margin:5% auto; width:95%; max-width:550px; padding:25px; border-radius:24px; max-height:85vh; overflow-y:auto; }

        /* TOAST */
        #toast {
            visibility:hidden; min-width:250px; background:#000; color:#fff;
            text-align:center; border-radius:12px; padding:16px;
            position:fixed; z-index:7000; left:50%; bottom:120px;
            transform:translateX(-50%); font-weight:600;
        }
        #toast.show { visibility:visible; animation:toastIn 0.3s ease, toastOut 0.3s 2.7s ease forwards; }
        @keyframes toastIn  { from{opacity:0;bottom:90px} to{opacity:1;bottom:120px} }
        @keyframes toastOut { to{opacity:0} }
    </style>
</head>
<body>

<div id="debugStatus">‚è≥ Veriler Y√ºkleniyor...</div>

<!-- LOGIN -->
<div id="loginOverlay">
    <div class="login-box">
        <h2 style="margin:0;font-weight:800;">AS SPOR</h2>
        <p style="color:#666;font-size:13px;margin-bottom:20px;">Showroom Personel Giri≈üi</p>
        <input type="text"     id="loginUser" class="login-input" placeholder="Kullanƒ±cƒ± Adƒ±"
               autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false">
        <input type="password" id="loginPass" class="login-input" placeholder="≈ûifre"
               autocomplete="current-password">
        <button onclick="checkLogin()" class="login-btn">Gƒ∞Rƒ∞≈û YAP</button>
        <div id="loginError" class="error-msg"></div>
    </div>
</div>

<!-- MAIN -->
<div class="header-hero">
    <div class="main-container"><h1 style="margin:0;">AS SPOR</h1></div>
</div>

<div class="main-container">
    <div class="user-welcome-bar">
        <div><b>Sorumlu:</b> <span id="displayUserName">-</span></div>
        <div style="display:flex;gap:10px;">
            <button onclick="openHistory()" style="background:#eee;border:none;padding:8px 12px;border-radius:8px;font-weight:600;cursor:pointer;font-size:12px;">
                <i class="fas fa-history"></i> Ge√ßmi≈ü
            </button>
            <button onclick="logout()" style="color:red;border:none;background:none;cursor:pointer;font-weight:700;">√áIKI≈û</button>
        </div>
    </div>

    <input type="text" id="dealerName" class="login-input"
           style="margin-top:15px;background:white;" placeholder="Bayi Adƒ± (Zorunlu)" autocomplete="off">

    <div class="search-container">
        <input type="text" id="searchInput" class="search-field"
               placeholder="√úr√ºn Kodu Ara (√ñrn: BKLITW25)" autocomplete="off">
        <button class="btn-scan"   onclick="searchProduct()"><i class="fas fa-search"></i></button>
        <button class="btn-camera" onclick="toggleCamera()"><i class="fas fa-camera"></i></button>
    </div>

    <!-- SCANNER -->
    <div id="reader-container">
        <div class="scanner-header">
            <span><i class="fas fa-camera" style="color:var(--accent);"></i> &nbsp;TARAYICI</span>
            <div class="scanner-mode-tabs">
                <button class="mode-tab active" id="tab-barcode" onclick="setMode('barcode')">
                    <i class="fas fa-barcode"></i> Barkod
                </button>
                <button class="mode-tab" id="tab-ocr" onclick="setMode('ocr')">
                    <i class="fas fa-font"></i> Yazƒ±
                </button>
            </div>
        </div>
        <div id="reader-viewport">
            <div id="reader"></div>
            <div class="scanner-overlay-top"></div>
            <div class="scanner-overlay-bottom"></div>
            <div class="scan-frame"><span></span></div>
            <div class="scanner-laser"></div>
            <div class="scan-hint" id="scanHint">Barkodu √ßer√ßeveye hizalayƒ±n</div>
        </div>
        <div class="ocr-controls">
            <button class="btn-ocr-trigger" id="btnOcrAction" onclick="captureOCR()">
                <i class="fas fa-camera"></i> YAZIYI TARA
            </button>
            <button class="btn-close-camera" onclick="toggleCamera()">
                <i class="fas fa-times"></i> &nbsp;KAPAT
            </button>
        </div>
    </div>

    <div id="resultsArea"></div>
</div>

<!-- FLOATING CART -->
<div class="floating-cart" onclick="openCart()">
    <i class="fas fa-shopping-basket fa-lg"></i>
    <div id="cartBadge" class="cart-badge">0</div>
</div>

<!-- CART MODAL -->
<div id="cartModal" class="modal">
    <div class="modal-content">
        <span onclick="closeModal('cartModal')" style="float:right;cursor:pointer;font-size:28px;">&times;</span>
        <h2 style="margin:0;font-weight:800;">Sepetim</h2>
        <div id="cartItems" style="margin-top:15px;"></div>
        <div style="margin-top:15px;text-align:right;font-size:18px;font-weight:800;">
            TOPLAM: <span id="cartTotal" style="color:var(--accent);">0.00</span>
        </div>
        <input type="email" id="customerEmail" class="login-input" style="margin-top:20px;" placeholder="M√º≈üteri Maili (Opsiyonel)">
        <div style="display:flex;gap:12px;margin-top:20px;">
            <button onclick="saveAndExport()"
                style="flex:1;background:#2ecc71;color:white;border:none;padding:15px;border-radius:12px;font-weight:800;cursor:pointer;">
                EXCEL ƒ∞NDƒ∞R
            </button>
            <button onclick="sendMail()" id="btnMail"
                style="flex:1;background:#000;color:white;border:none;padding:15px;border-radius:12px;font-weight:800;cursor:pointer;">
                MAƒ∞L AT
            </button>
        </div>
    </div>
</div>

<!-- HISTORY MODAL -->
<div id="historyModal" class="modal">
    <div class="modal-content">
        <span onclick="closeModal('historyModal')" style="float:right;cursor:pointer;font-size:28px;">&times;</span>
        <h2 style="margin:0;font-weight:800;">Sipari≈ü Ge√ßmi≈üi</h2>
        <div id="historyList" style="margin-top:15px;"></div>
    </div>
</div>

<!-- PRODUCT DETAIL MODAL (bottom sheet) -->
<div id="productModal" onclick="closeProductModal(event)">
    <div id="productModalBox">
        <button class="pm-close-btn" onclick="closeModal('productModal')">&times;</button>
        <img id="productModalImg" src="" alt="">
        <div class="pm-body">
            <div class="pm-code" id="pm-code"></div>
            <div class="pm-name" id="pm-name"></div>
            <div class="pm-ean"  id="pm-ean"></div>
            <div class="pm-price" id="pm-price"></div>
            <div class="pm-sizes-title">Beden Se√ßin & Adet Girin</div>
            <div id="pm-sizes"></div>
            <button class="pm-add-btn" onclick="addToCartFromModal()">
                <i class="fas fa-shopping-basket"></i> &nbsp;SEPETE EKLE
            </button>
        </div>
    </div>
</div>

<!-- STICKY CART BAR -->
<div id="cartBar">
    <div class="cart-bar-left">
        <span class="cart-bar-count" id="cartBarCount">0 √ºr√ºn</span>
        <span class="cart-bar-total" id="cartBarTotal">0.00 TL</span>
    </div>
    <button class="cart-bar-btn" onclick="openCart()">
        <i class="fas fa-shopping-basket"></i> &nbsp;Sepeti G√∂r
    </button>
</div>

<div id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// 1. CONSTANTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const EMAILJS_SERVICE_ID  = "service_qh7mngr";
const EMAILJS_TEMPLATE_ID = "template_2e5jxvh";
const EMAILJS_PUBLIC_KEY  = "VSRTcl2JLxhmNWT4a";
const FIXED_EMAILS        = "emel@asspor.com, siparis@asspor.com";

const USERS = {
    "adnankaya":   { name: "Adnan Kaya",   pass: "1234" },
    "cinargokce":  { name: "√áƒ±nar G√∂k√ße",  pass: "1234" },
    "lutfuozturk": { name: "L√ºtf√º √ñzt√ºrk", pass: "1234" },
    "meftunicay":  { name: "Meftuni √áay",  pass: "1234" },
    "muratturgut": { name: "Murat Turgut", pass: "1234" },
    "ozkanocak":   { name: "√ñzkan Ocak",   pass: "1234" },
    "serkanmert":  { name: "Serkan Mert",  pass: "1234" },
    "admin":       { name: "Test Admin",   pass: "1234" }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// 2. STATE  ‚Üê all variables declared ONCE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const beepSound     = new Audio("https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3");
let html5QrCode     = null;
let isCameraRunning = false;
let scanMode        = 'barcode';
let currentUser     = null;
let inventory       = [];
let cart            = [];
let groupedResults  = {};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// 3. INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.addEventListener('load', () => {
    emailjs.init(EMAILJS_PUBLIC_KEY);

    // Enter key support on login fields
    document.getElementById('loginPass').addEventListener('keydown', e => { if(e.key==='Enter') checkLogin(); });
    document.getElementById('loginUser').addEventListener('keydown', e => { if(e.key==='Enter') document.getElementById('loginPass').focus(); });
    // Enter key support on search
    document.getElementById('searchInput').addEventListener('keydown', e => { if(e.key==='Enter') searchProduct(); });

    // SESSION RESTORE ‚Äî validate token, never auto-login without correct credentials
    const savedUser  = localStorage.getItem('asSpor_user');
    const savedToken = localStorage.getItem('asSpor_token');
    if (savedUser && USERS[savedUser] && savedToken === _makeToken(savedUser, USERS[savedUser].pass)) {
        loginSuccess(savedUser, false);
    } else {
        _clearSession(); // wipe any stale data
    }

    loadInventory();
});

function _makeToken(u, p) { return btoa(encodeURIComponent(u + '\x00' + p)); }
function _clearSession() {
    localStorage.removeItem('asSpor_user');
    localStorage.removeItem('asSpor_token');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// 4. DATA LOADING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadInventory() {
    const bar = document.getElementById('debugStatus');
    Papa.parse('data.csv', {
        download: true, header: true, delimiter: ";", skipEmptyLines: 'greedy',
        complete: (r) => {
            inventory = r.data.filter(row => row['Product'] || row['Reference']);
            bar.style.background = '#27ae60';
            bar.innerText = `‚úÖ ${inventory.length.toLocaleString('tr-TR')} √ºr√ºn y√ºklendi`;
            setTimeout(() => { bar.style.display = 'none'; }, 3000);
        },
        error: (err) => {
            bar.style.background = '#e74c3c';
            bar.innerText = '‚ùå Veri y√ºklenemedi! data.csv kontrol edin.';
            console.error('CSV error:', err);
        }
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// 5. AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function checkLogin() {
    const errEl = document.getElementById('loginError');
    errEl.style.display = 'none';

    const u = document.getElementById('loginUser').value.trim().toLowerCase().replace(/\s+/g,'');
    const p = document.getElementById('loginPass').value;

    // Require BOTH fields ‚Äî previously empty password was allowed
    if (!u || !p) {
        errEl.innerText = 'Kullanƒ±cƒ± adƒ± ve ≈üifre giriniz!';
        errEl.style.display = 'block';
        return;
    }

    if (USERS[u] && USERS[u].pass === p) {
        localStorage.setItem('asSpor_user',  u);
        localStorage.setItem('asSpor_token', _makeToken(u, p));
        loginSuccess(u, true);
    } else {
        errEl.innerText = 'Kullanƒ±cƒ± adƒ± veya ≈üifre hatalƒ±!';
        errEl.style.display = 'block';
        document.getElementById('loginPass').value = '';
        document.getElementById('loginPass').focus();
    }
}

function loginSuccess(key, animate) {
    currentUser = USERS[key];
    document.getElementById('displayUserName').innerText = currentUser.name;
    const ov = document.getElementById('loginOverlay');
    if (animate) {
        ov.style.opacity = '0';
        setTimeout(() => ov.style.display = 'none', 300);
    } else {
        ov.style.display = 'none';
    }
}

function logout() {
    _clearSession();
    if (isCameraRunning && html5QrCode) {
        html5QrCode.stop().catch(()=>{}).finally(()=> location.reload());
    } else {
        location.reload();
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// 6. CAMERA ‚Äî BARCODE + OCR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.setMode = function(mode) {
    scanMode = mode;
    document.getElementById('tab-barcode').classList.toggle('active', mode === 'barcode');
    document.getElementById('tab-ocr').classList.toggle('active',     mode === 'ocr');
    document.getElementById('btnOcrAction').style.display = mode === 'ocr' ? 'flex' : 'none';
    document.getElementById('scanHint').innerText = mode === 'barcode'
        ? 'Barkodu √ßer√ßeveye hizalayƒ±n'
        : "√úr√ºn kodunu √ßer√ßeveye hizalayƒ±n, sonra TARA'ya bas";
};

window.toggleCamera = async function() {
    const container = document.getElementById('reader-container');
    if (isCameraRunning && html5QrCode) {
        try { await html5QrCode.stop(); html5QrCode.clear(); } catch(e) { console.warn(e); }
        isCameraRunning = false;
        container.style.display = 'none';
        return;
    }
    container.style.display = 'block';
    setMode('barcode');
    html5QrCode = new Html5Qrcode("reader"); // always fresh instance

    const config = {
        fps: 20,
        qrbox: { width: 240, height: 52 },
        aspectRatio: 16 / 9,
        formatsToSupport: [
            Html5QrcodeSupportedFormats.EAN_13,
            Html5QrcodeSupportedFormats.EAN_8,
            Html5QrcodeSupportedFormats.CODE_128,
            Html5QrcodeSupportedFormats.CODE_39,
            Html5QrcodeSupportedFormats.QR_CODE,
            Html5QrcodeSupportedFormats.DATA_MATRIX
        ]
    };

    try {
        await html5QrCode.start(
            { facingMode: "environment" },
            config,
            async (decodedText) => {
                if (scanMode !== 'barcode') return;
                beepSound.play().catch(()=>{});
                document.getElementById('searchInput').value = decodedText;
                searchProduct();
                showToast("üì∏ Barkod: " + decodedText);
                if (isCameraRunning) {
                    try { await html5QrCode.stop(); html5QrCode.clear(); } catch(e) {}
                    isCameraRunning = false;
                }
                container.style.display = 'none';
            },
            () => {}
        );
        isCameraRunning = true;
    } catch(err) {
        showToast("Kamera a√ßƒ±lamadƒ± ‚Äî l√ºtfen izin verin.");
        console.error('Camera error:', err);
        container.style.display = 'none';
    }
};

window.captureOCR = async function() {
    const video = document.querySelector('#reader video');
    if (!video || !isCameraRunning) return showToast("Kamera aktif deƒüil!");
    if (video.readyState < 2) return showToast("Kamera hazƒ±rlanƒ±yor, bekleyin...");

    const btn = document.getElementById('btnOcrAction');
    btn.innerHTML = '‚è≥ Analiz...'; btn.disabled = true;

    const vw = video.videoWidth, vh = video.videoHeight;
    const stripH = Math.round(vh * 0.22);
    const stripY = Math.round((vh - stripH) / 2);
    const canvas = document.createElement('canvas');
    canvas.width = vw; canvas.height = stripH;
    canvas.getContext('2d').drawImage(video, 0, stripY, vw, stripH, 0, 0, vw, stripH);

    try {
        const result = await Tesseract.recognize(canvas, 'eng', {
            tessedit_pageseg_mode: '8',
            tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'
        });
        const cleaned = result.data.text.trim().toUpperCase().replace(/[^A-Z0-9]/g,'');
        if (cleaned.length >= 4) {
            beepSound.play().catch(()=>{});
            document.getElementById('searchInput').value = cleaned;
            searchProduct();
            showToast("üìù Algƒ±lanan: " + cleaned);
            if (isCameraRunning) {
                try { await html5QrCode.stop(); html5QrCode.clear(); } catch(e) {}
                isCameraRunning = false;
            }
            document.getElementById('reader-container').style.display = 'none';
        } else {
            showToast("Okunamadƒ± ‚Äî kodu √ßer√ßeveye yakla≈ütƒ±r.");
        }
    } catch(e) {
        showToast("OCR hatasƒ± ‚Äî tekrar dene.");
        console.error('OCR error:', e);
    } finally {
        btn.innerHTML = '<i class="fas fa-camera"></i> YAZIYI TARA';
        btn.disabled = false;
    }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// 7. SEARCH & PRODUCT CARDS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function searchProduct() {
    const q = document.getElementById('searchInput').value.toUpperCase().trim();
    if (!q) return;
    if (inventory.length === 0) return showToast("Veriler hen√ºz y√ºklenmedi, bekleyin.");

    const matches = inventory.filter(row =>
        (row['Product']     || '').toUpperCase().includes(q) ||
        (row['Description'] || '').toUpperCase().includes(q)
    );
    if (matches.length === 0) return showToast("√úr√ºn bulunamadƒ±: " + q);

    groupedResults = {};
    matches.forEach(item => {
        const code = item['Product'] || item['Reference'] || '?';
        if (!groupedResults[code]) groupedResults[code] = [];
        groupedResults[code].push(item);
    });
    renderResults();
    document.getElementById('searchInput').value = '';
    document.getElementById('resultsArea').scrollIntoView({ behavior:'smooth', block:'start' });
}

function escHtml(s) {
    return String(s||'')
        .replace(/&/g,'&amp;').replace(/</g,'&lt;')
        .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function safeId(s) { return String(s).replace(/[^A-Za-z0-9_-]/g,'_'); }

// Compact grid cards ‚Äî click opens detail modal
function renderResults() {
    const area = document.getElementById('resultsArea');
    area.innerHTML = '';
    Object.keys(groupedResults).forEach((code, i) => {
        const group = groupedResults[code];
        const first = group[0];
        const safeCode = code.replace(/\\/g,'\\\\').replace(/'/g,"\\'");

        const card = document.createElement('div');
        card.className = 'product-card';
        card.style.animationDelay = (i * 0.04) + 's';
        card.onclick = () => openProductModal(code);
        card.innerHTML = `
            ${first.ImageURL
                ? `<img src="${escHtml(first.ImageURL)}" class="product-img" onerror="this.style.display='none'" alt="">`
                : `<div style="height:140px;background:#f5f5f5;display:flex;align-items:center;justify-content:center;color:#ccc;font-size:32px;"><i class="fas fa-tshirt"></i></div>`}
            <div class="product-info-wrapper">
                <p class="product-code-label">${escHtml(code)}</p>
                <p class="product-name-label">${escHtml(first['Description']||'')}</p>
                <span class="price-tag">${escHtml(first['Tariff Price']||'-')} ${escHtml(first['Currency']||'')}</span>
            </div>`;
        area.appendChild(card);
    });
}

// ‚îÄ‚îÄ PRODUCT DETAIL MODAL ‚îÄ‚îÄ
let modalCurrentCode = null;

window.openProductModal = function(code) {
    const group = groupedResults[code];
    if (!group || !group.length) return;
    const first = group[0];
    modalCurrentCode = code;

    document.getElementById('productModalImg').src = first.ImageURL || '';
    document.getElementById('productModalImg').style.display = first.ImageURL ? 'block' : 'none';
    document.getElementById('pm-code').innerText  = code;
    document.getElementById('pm-name').innerText  = first['Description'] || '';
    document.getElementById('pm-ean').innerText   = first['EAN'] ? 'EAN: ' + first['EAN'] : '';
    document.getElementById('pm-price').innerText =
        (first['Tariff Price'] || '-') + ' ' + (first['Currency'] || '');

    // Build size rows
    const sizesEl = document.getElementById('pm-sizes');
    sizesEl.innerHTML = group.map((item, idx) => `
        <div class="pm-size-row">
            <div>
                <span class="pm-size-label">${escHtml(item['EUR Size'] || '-')}</span>
                <span class="pm-stock-label"> ¬∑ Stok: ${escHtml(String(item['Stock Quantity']||0))}</span>
            </div>
            <div class="pm-qty-ctrl">
                <button class="pm-btn-qty" onclick="pmChangeQty(${idx},-1)">‚àí</button>
                <input type="number" id="pm-qty-${idx}" class="pm-qty-inp" value="0" min="0"
                       max="${parseInt(item['Stock Quantity'])||999}">
                <button class="pm-btn-qty" onclick="pmChangeQty(${idx},1,${parseInt(item['Stock Quantity'])||999})">+</button>
            </div>
        </div>`).join('');

    const modal = document.getElementById('productModal');
    modal.classList.add('open');
    document.body.style.overflow = 'hidden';
};

window.pmChangeQty = function(idx, delta, max) {
    const el = document.getElementById('pm-qty-' + idx);
    if (!el) return;
    let v = parseInt(el.value || 0) + delta;
    v = Math.max(0, max !== undefined ? Math.min(v, max) : v);
    el.value = v;
};

window.closeProductModal = function(e) {
    // Close if backdrop clicked (not the modal box itself)
    if (e && e.target !== document.getElementById('productModal')) return;
    _closeProductModal();
};

function _closeProductModal() {
    document.getElementById('productModal').classList.remove('open');
    document.body.style.overflow = '';
    modalCurrentCode = null;
}

window.addToCartFromModal = function() {
    const code = modalCurrentCode;
    if (!code) return;
    const dealer = document.getElementById('dealerName').value.trim();
    if (!dealer) return showToast("Bayi adƒ± giriniz!");

    const group = groupedResults[code];
    let added = 0;
    group.forEach((item, idx) => {
        const qEl = document.getElementById('pm-qty-' + idx);
        if (!qEl) return;
        const q = parseInt(qEl.value || 0);
        if (q > 0) {
            cart.push({ ...item, qty: q, price: parseFloat(item['Tariff Price']) || 0, dealer });
            added += q;
        }
    });

    if (added > 0) {
        updateCartUI();
        showToast(`‚úÖ ${added} adet sepete eklendi.`);
        _closeProductModal();
    } else {
        showToast("L√ºtfen en az bir beden i√ßin adet girin.");
    }
};

function updateCartUI() {
    const count = cart.reduce((s,i) => s + i.qty, 0);
    const total = cart.reduce((s,i) => s + i.price * i.qty, 0);
    const currency = (cart[0] && cart[0]['Currency']) || 'TL';
    const totalStr = total.toFixed(2) + ' ' + currency;

    // Floating button badge
    document.getElementById('cartBadge').innerText = cart.length;

    // Cart modal total
    document.getElementById('cartTotal').innerText = totalStr;

    // Sticky bottom bar
    const bar = document.getElementById('cartBar');
    if (cart.length > 0) {
        bar.classList.add('visible');
        document.getElementById('cartBarCount').innerText = count + ' adet ¬∑ ' + cart.length + ' kalem';
        document.getElementById('cartBarTotal').innerText = totalStr;
    } else {
        bar.classList.remove('visible');
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// 8. CART MODAL ‚Äî sizes editable inside cart
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.openCart = () => {
    const list = document.getElementById('cartItems');
    if (cart.length === 0) {
        list.innerHTML = '<p style="text-align:center;color:#bbb;padding:30px 0;">Sepetiniz bo≈ü.</p>';
    } else {
        list.innerHTML = cart.map((item, idx) => `
            <div class="cart-size-row">
                <div class="cart-size-info">
                    <b>${escHtml(item['Product']||'')} ‚Äî ${escHtml(item['EUR Size']||'')}</b>
                    <small>${escHtml(item['Description']||'')} ¬∑ ${item.price.toFixed(2)} ${escHtml(item['Currency']||'')}</small>
                </div>
                <div style="display:flex;align-items:center;gap:8px;">
                    <div class="cart-qty-ctrl">
                        <button class="cart-btn-qty" onclick="cartChangeQty(${idx},-1)">‚àí</button>
                        <input type="number" id="cqty-${idx}" class="cart-qty-val"
                               value="${item.qty}" min="1" onchange="cartSetQty(${idx},this.value)">
                        <button class="cart-btn-qty" onclick="cartChangeQty(${idx},1)">+</button>
                    </div>
                    <span onclick="removeFromCart(${idx})"
                        style="color:#ff4d4d;cursor:pointer;font-size:22px;padding:0 4px;">&times;</span>
                </div>
            </div>`).join('');
    }
    document.getElementById('cartModal').style.display = 'block';
};

window.cartChangeQty = (idx, delta) => {
    const el = document.getElementById('cqty-' + idx);
    if (!el) return;
    const newVal = Math.max(1, parseInt(el.value || 1) + delta);
    el.value = newVal;
    cart[idx].qty = newVal;
    updateCartUI();
    // re-render total line without closing modal
    document.getElementById('cartTotal').innerText =
        cart.reduce((s,i)=>s+i.price*i.qty,0).toFixed(2) + ' ' + ((cart[0]&&cart[0]['Currency'])||'TL');
};

window.cartSetQty = (idx, val) => {
    const q = Math.max(1, parseInt(val) || 1);
    cart[idx].qty = q;
    const el = document.getElementById('cqty-' + idx);
    if (el) el.value = q;
    updateCartUI();
};

window.removeFromCart = (idx) => {
    cart.splice(idx, 1);
    updateCartUI();
    openCart();
};

window.closeModal = (id) => {
    if (id === 'productModal') { _closeProductModal(); return; }
    document.getElementById(id).style.display = 'none';
};
// backward compat alias
window.closeCart = () => closeModal('cartModal');

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// 9. EXCEL EXPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveAndExport() {
    if (cart.length === 0) return showToast("Sepet bo≈ü!");
    const dealer = document.getElementById('dealerName').value.trim() || 'siparis';
    saveToHistory(cart, dealer);
    const rows = cart.map(i => ({
        '√úr√ºn Kodu':   i['Product']     || '',
        'A√ßƒ±klama':    i['Description'] || '',
        'Beden':       i['EUR Size']    || '',
        'Adet':        i.qty,
        'Birim Fiyat': i.price,
        'Toplam':      (i.price * i.qty).toFixed(2),
        'Para Birimi': i['Currency']    || '',
        'Bayi':        i.dealer         || ''
    }));
    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Siparis");
    XLSX.writeFile(wb, `Siparis_${dealer}_${new Date().toISOString().slice(0,10)}.xlsx`);
    showToast("‚úÖ Excel indirildi.");
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// 10. EMAIL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function sendMail() {
    if (cart.length === 0) return showToast("Sepet bo≈ü!");
    const dealer = document.getElementById('dealerName').value.trim();
    if (!dealer) return showToast("Bayi adƒ± giriniz!");

    const btn = document.getElementById('btnMail');
    btn.disabled = true; btn.innerText = "G√ñNDERƒ∞Lƒ∞YOR...";

    let table = `<table border="1" cellpadding="6" style="border-collapse:collapse;width:100%;font-family:sans-serif;">
        <tr style="background:#000;color:#fff;">
            <th>Kod</th><th>√úr√ºn</th><th>Beden</th><th>Adet</th><th>Toplam</th>
        </tr>`;
    cart.forEach(i => {
        table += `<tr>
            <td>${escHtml(i['Product'])}</td>
            <td>${escHtml(i['Description'])}</td>
            <td>${escHtml(i['EUR Size'])}</td>
            <td>${i.qty}</td>
            <td>${(i.price * i.qty).toFixed(2)} ${escHtml(i['Currency']||'')}</td>
        </tr>`;
    });
    table += '</table>';

    const extra = document.getElementById('customerEmail').value.trim();
    const params = {
        manager:        currentUser.name,
        dealer,
        customer_email: FIXED_EMAILS + (extra ? ', ' + extra : ''),
        order_details:  table,
        total_qty:      cart.reduce((s,i) => s + i.qty, 0)
    };

    emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, params)
        .then(() => {
            saveToHistory(cart, dealer);
            showToast("‚úÖ Mail g√∂nderildi!");
            cart = []; updateCartUI(); closeCart();
            document.getElementById('customerEmail').value = '';
        })
        .catch(err => {
            console.error('EmailJS:', err);
            showToast("‚ùå Mail g√∂nderilemedi.");
        })
        .finally(() => { btn.disabled = false; btn.innerText = "MAƒ∞L AT"; });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// 11. ORDER HISTORY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveToHistory(items, dealer) {
    try {
        let h = JSON.parse(localStorage.getItem('asSpor_history') || '[]');
        h.unshift({ id: Date.now(), date: new Date().toLocaleString('tr-TR'), dealer, items });
        localStorage.setItem('asSpor_history', JSON.stringify(h.slice(0,50)));
    } catch(e) { console.warn('History save failed:', e); }
}

window.openHistory = () => {
    let h = [];
    try { h = JSON.parse(localStorage.getItem('asSpor_history') || '[]'); } catch(e) {}
    const list = document.getElementById('historyList');
    list.innerHTML = h.length
        ? h.map(o => `
            <div style="padding:12px;background:#f9f9f9;border-radius:12px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <b>${escHtml(o.dealer)}</b><br>
                    <small style="color:#aaa;">${o.date} ¬∑ ${o.items.length} kalem</small>
                </div>
                <button onclick="downloadHistItem(${o.id})"
                    style="background:#2ecc71;border:none;color:white;padding:7px 13px;border-radius:8px;cursor:pointer;font-weight:700;white-space:nowrap;">
                    Excel
                </button>
            </div>`).join('')
        : '<p style="color:#bbb;text-align:center;padding:20px;">Ge√ßmi≈ü yok.</p>';
    document.getElementById('historyModal').style.display = 'block';
};

window.downloadHistItem = (id) => {
    try {
        const h   = JSON.parse(localStorage.getItem('asSpor_history') || '[]');
        const rec = h.find(o => o.id === id);
        if (!rec) return showToast("Kayƒ±t bulunamadƒ±.");
        const rows = rec.items.map(i => ({
            '√úr√ºn Kodu':   i['Product']     || '',
            'A√ßƒ±klama':    i['Description'] || '',
            'Beden':       i['EUR Size']    || '',
            'Adet':        i.qty,
            'Birim Fiyat': i.price,
            'Toplam':      (i.price * i.qty).toFixed(2),
            'Para Birimi': i['Currency']    || '',
            'Bayi':        i.dealer         || ''
        }));
        const ws = XLSX.utils.json_to_sheet(rows);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Siparis");
        XLSX.writeFile(wb, `Gecmis_${rec.dealer}_${rec.id}.xlsx`);
    } catch(e) { showToast("ƒ∞ndirme hatasƒ±."); }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// 12. TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.showToast = (msg) => {
    const t = document.getElementById('toast');
    t.innerText = msg;
    t.className = '';
    void t.offsetWidth; // force reflow so animation restarts correctly
    t.className = 'show';
    clearTimeout(t._hideTimer);
    t._hideTimer = setTimeout(() => { t.className = ''; }, 3000);
};
</script>
</body>
</html>
