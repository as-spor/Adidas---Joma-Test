<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>As Spor - Showroom Sistemi</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <link rel="apple-touch-icon" href="icon-192.png">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root { --primary: #000; --accent: #00AEEF; --bg: #f8f9fb; --radius: 18px; --success: #2ecc71; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding-bottom: 140px; color: #1a1a1a; }

        #debugStatus { background: #f39c12; color: #fff; padding: 10px; text-align: center; font-weight: 700; font-size: 14px; position: fixed; top: 0; left: 0; width: 100%; z-index: 9999; }

        #loginOverlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--primary); z-index: 10000; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
        .login-box { background: #fff; width: 100%; max-width: 350px; padding: 40px 30px; border-radius: 24px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.4); }
        .login-input { width: 100%; padding: 15px; margin: 10px 0; border: 2px solid #eee; border-radius: 12px; outline: none; font-family: 'Inter'; font-size: 16px; }
        .login-btn { width: 100%; background: var(--accent); color: #fff; padding: 15px; border: none; border-radius: 12px; font-weight: 800; cursor: pointer; margin-top: 10px; font-size: 16px; }

        .header-hero { background: var(--primary); color: #fff; padding: 50px 20px 80px; border-bottom: 6px solid var(--accent); }
        .main-container { max-width: 1200px; margin: 0 auto; padding: 0 15px; }
        .user-welcome-bar { background: #fff; padding: 15px 20px; border-radius: var(--radius); margin-top: -50px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); display: flex; align-items: center; justify-content: space-between; }

        .search-container { background: #fff; padding: 8px; border-radius: var(--radius); margin-top: 20px; display: flex; gap: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.04); }
        .search-field { flex: 1; border: none; padding-left: 15px; outline: none; font-size: 16px; }
        .btn-scan { background: var(--primary); color: #fff; border: none; width: 55px; height: 50px; border-radius: 14px; cursor: pointer; }
        .btn-camera { background: var(--accent); color: #fff; border: none; width: 55px; height: 50px; border-radius: 14px; cursor: pointer; }

        #reader-container { width: 100%; margin-top: 15px; display: none; background: #111; border-radius: 22px; overflow: hidden; }
        #reader-viewport { position: relative; width: 100%; height: 220px; background: #000; }
        #reader { width: 100% !important; height: 220px !important; }
        .scanner-laser { position: absolute; left: 10%; width: 80%; height: 2px; background: red; box-shadow: 0 0 8px red; z-index: 9; animation: laserSweep 1.6s infinite ease-in-out; }
        @keyframes laserSweep { 0%,100%{top:40px} 50%{top:180px} }

        #resultsArea { display: grid; grid-template-columns: repeat(2, 1fr); gap: 14px; margin-top: 25px; }
        .product-card { background: #fff; border-radius: 16px; overflow: hidden; box-shadow: 0 3px 12px rgba(0,0,0,0.07); border: 1.5px solid #eee; display: flex; flex-direction: column; cursor: pointer; }
        .product-img { width: 100%; height: 220px; object-fit: contain; background: #fff; padding: 15px; border-bottom: 1px solid #f2f2f2; }
        .product-info-wrapper { padding: 12px 14px; }
        .product-code-label { font-size: 10px; color: var(--accent); font-weight: 800; text-transform: uppercase; }
        .product-name-label { font-size: 14px; font-weight: 800; color: #000; margin-top: 4px; }
        .product-ean-label { font-size: 10px; color: #bbb; font-weight: 600; margin-top: 2px; }

        #productModal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.72); z-index: 11000; align-items: flex-end; justify-content: center; }
        #productModal.open { display: flex; }
        #productModalBox { background: #fff; width: 100%; max-width: 560px; border-radius: 28px 28px 0 0; padding-bottom: 40px; max-height: 92vh; overflow-y: auto; position: relative; }
        .pm-qty-inp { width: 55px; text-align: center; border: 2px solid #eee; border-radius: 12px; height: 38px; font-weight: 700; outline: none; }

        .cart-group { border: 1.5px solid #eee; border-radius: 18px; margin-bottom: 16px; overflow: hidden; background: #fff; }
        .cart-group-header { background: #fcfcfc; padding: 14px; border-bottom: 1px solid #f5f5f5; display: flex; gap: 12px; align-items: center; }
        .cart-thumb { width: 60px; height: 60px; border-radius: 10px; object-fit: contain; border: 1px solid #eee; background: #fff; }

        .floating-cart { position: fixed; bottom: 85px; right: 20px; background: var(--accent); color: #fff; width: 60px; height: 60px; border-radius: 50%; display: flex; justify-content: center; align-items: center; box-shadow: 0 10px 25px rgba(0,174,239,0.4); z-index: 9001; cursor: pointer; }
        .cart-badge { position: absolute; top: -5px; right: -5px; background: #ff4d4d; color: #fff; border-radius: 50%; width: 24px; height: 24px; font-size: 12px; display: flex; justify-content: center; align-items: center; border: 2px solid #fff; font-weight: 800; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 12000; }
        .modal-content { background: white; margin: 5% auto; width: 95%; max-width: 500px; padding: 25px; border-radius: 24px; max-height: 85vh; overflow-y: auto; }

        /* ‚îÄ‚îÄ YENƒ∞: ƒ∞≈û AKI≈ûI BUTONLARI ‚îÄ‚îÄ */
        .btn-confirm-order { width: 100%; background: var(--primary); color: #fff; border: none; padding: 18px; border-radius: 15px; font-weight: 800; font-size: 16px; cursor: pointer; margin-top: 10px; }
        .post-confirm-actions { display: none; flex-direction: column; gap: 10px; margin-top: 10px; }
        .btn-new-order { width: 100%; background: #fff; color: #ff4d4d; border: 2px solid #ff4d4d; padding: 15px; border-radius: 12px; font-weight: 800; margin-top: 30px; cursor: pointer; }
        
        #toast { visibility: hidden; min-width: 250px; background: #000; color: #fff; text-align: center; border-radius: 50px; padding: 16px; position: fixed; z-index: 20000; left: 50%; bottom: 120px; transform: translateX(-50%); font-weight: 600; }
        #toast.show { visibility: visible; }
    </style>
</head>
<body>

<div id="debugStatus">‚è≥ Veriler Y√ºkleniyor...</div>

<div id="loginOverlay">
    <div class="login-box">
        <h2 style="margin:0;font-weight:800;">AS SPOR</h2>
        <p style="color:#666;font-size:13px;margin-bottom:20px;">Showroom Personel Giri≈üi</p>
        <input type="text" id="loginUser" class="login-input" placeholder="Kullanƒ±cƒ± Adƒ±" autocomplete="off">
        <input type="password" id="loginPass" class="login-input" placeholder="≈ûifre">
        <button onclick="checkLogin()" class="login-btn">Gƒ∞Rƒ∞≈û YAP</button>
        <div id="loginError" style="color:red; display:none; margin-top:10px;"></div>
    </div>
</div>

<div class="header-hero"><div class="main-container"><h1 style="margin:0;">AS SPOR</h1></div></div>

<div class="main-container">
    <div class="user-welcome-bar">
        <div><b>Sorumlu:</b> <span id="displayUserName">-</span></div>
        <div style="display:flex;gap:10px;">
            <button onclick="openHistory()" style="background:#eee;border:none;padding:8px 12px;border-radius:8px;font-weight:600;cursor:pointer;font-size:12px;">Ge√ßmi≈ü</button>
            <button onclick="logout()" style="color:red;border:none;background:none;cursor:pointer;font-weight:700;">√áIKI≈û</button>
        </div>
    </div>

    <input type="text" id="dealerName" class="login-input" style="margin-top:15px;background:#fff;" placeholder="Bayi Adƒ± (Zorunlu)" oninput="persistDealer()">

    <div class="search-container">
        <input type="text" id="searchInput" class="search-field" placeholder="√úr√ºn Kodu veya ƒ∞sim Ara...">
        <button class="btn-scan" onclick="searchProduct()"><i class="fas fa-search"></i></button>
        <button class="btn-camera" onclick="toggleCamera()"><i class="fas fa-camera"></i></button>
    </div>

    <div id="reader-container">
        <div id="reader-viewport"><div id="reader"></div><div class="scanner-laser"></div></div>
        <button onclick="toggleCamera()" style="width:100%;background:#222;color:#ccc;border:none;padding:15px;font-weight:700;">KAPAT</button>
    </div>

    <div id="resultsArea"></div>
</div>

<div class="floating-cart" onclick="openCart()"><i class="fas fa-shopping-basket"></i><div id="cartBadge" class="cart-badge">0</div></div>

<div id="cartModal" class="modal">
    <div class="modal-content">
        <span onclick="closeModal('cartModal')" style="float:right;cursor:pointer;font-size:28px;">&times;</span>
        <h2 style="margin:0 0 15px;font-weight:800;">Sepetim</h2>
        <div id="cartItems"></div>
        <div style="margin-top:20px;text-align:right;font-size:22px;font-weight:800;">TOPLAM: <span id="cartTotal" style="color:var(--accent);">0.00</span></div>
        
        <button id="btnConfirmOrder" onclick="confirmAndLockOrder()" class="btn-confirm-order">Sƒ∞PARƒ∞≈ûƒ∞ ONAYLA VE KAYDET</button>

        <div id="postConfirmActions" class="post-confirm-actions">
            <p style="color:var(--success); font-weight:700; text-align:center; font-size:13px; margin:5px 0;">‚úì Sipari≈ü Ge√ßmi≈üe Kaydedildi</p>
            <input type="email" id="customerEmail" class="login-input" style="background:#f9f9f9" placeholder="M√º≈üteri Maili (Opsiyonel)">
            <div style="display:flex;gap:12px;">
                <button onclick="saveAndExport()" style="flex:1;background:#2ecc71;color:#fff;border:none;padding:15px;border-radius:12px;font-weight:800;">EXCEL</button>
                <button onclick="sendMail()" id="btnMail" style="flex:1;background:#000;color:#fff;border:none;padding:15px;border-radius:12px;font-weight:800;">MAƒ∞L AT</button>
            </div>
            <button onclick="confirmClearCart()" class="btn-new-order">YENƒ∞ SATI≈ûA BA≈ûLA (SEPETƒ∞ TEMƒ∞ZLE)</button>
        </div>
    </div>
</div>

<div id="historyModal" class="modal"><div class="modal-content"><span onclick="closeModal('historyModal')" style="float:right;cursor:pointer;font-size:28px;">&times;</span><h2 style="font-weight:800;">Sipari≈ü Ge√ßmi≈üi</h2><div id="historyList"></div></div></div>

<div id="productModal">
    <div id="productModalBox">
        <span onclick="_closeProductModal()" style="position:absolute;top:15px;right:20px;font-size:32px;cursor:pointer;z-index:10;">&times;</span>
        <img id="productModalImg" src="" style="width:100%;height:280px;object-fit:contain;padding:20px;background:#fff">
        <div style="padding:20px;">
            <div id="pm-code" style="color:var(--accent);font-weight:800;font-size:12px;"></div>
            <div id="pm-name" style="font-size:20px;font-weight:800;margin:4px 0;"></div>
            <div id="pm-ean" style="font-size:11px;color:#bbb;font-weight:600;"></div>
            <div id="pm-desc" style="font-size:13px;color:#666;margin:10px 0;line-height:1.4;"></div>
            <div id="pm-price" style="font-size:26px;font-weight:800;color:var(--accent);margin-bottom:18px;"></div>
            <div id="pm-sizes"></div>
            <button onclick="addToCartFromModal()" style="width:100%;background:#000;color:#fff;border:none;padding:18px;border-radius:15px;font-weight:800;margin-top:20px;">SEPETE EKLE</button>
        </div>
    </div>
</div>

<div id="toast"></div>

<script>
const EMAILJS_SVC = "service_qh7mngr", EMAILJS_TMP = "template_2e5jxvh", EMAILJS_KEY = "VSRTcl2JLxhmNWT4a";
const USERS = { "adnankaya": "1234", "cinargokce": "1234", "lutfuozturk": "1234", "meftunicay": "1234", "muratturgut": "1234", "ozkanocak": "1234", "serkanmert": "1234", "admin": "1234" };

let inventory = [], cart = [], groupedResults = {}, currentU = null, html5QrCode = null, modalCode = null;
const beep = new Audio("https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3");

window.onload = function() {
    emailjs.init(EMAILJS_KEY);
    const saved = localStorage.getItem('as_active_user');
    if(saved) loginSuccess(saved);

    Papa.parse('data.csv', {
        download: true, header: true, delimiter: ";", skipEmptyLines: 'greedy',
        complete: (r) => { inventory = r.data.filter(row => row['Product'] || row['Reference']); document.getElementById('debugStatus').style.display='none'; }
    });
};

function checkLogin() {
    const u = document.getElementById('loginUser').value.trim().toLowerCase();
    const p = document.getElementById('loginPass').value;
    if(USERS[u] && USERS[u] === p) { localStorage.setItem('as_active_user', u); loginSuccess(u); }
    else { document.getElementById('loginError').style.display='block'; document.getElementById('loginError').innerText="Hatalƒ±!"; }
}

function loginSuccess(u) {
    currentU = u;
    document.getElementById('displayUserName').innerText = u.toUpperCase();
    document.getElementById('loginOverlay').style.display='none';
    const savedCart = localStorage.getItem('as_cart_' + u);
    cart = savedCart ? JSON.parse(savedCart) : [];
    const savedDealer = localStorage.getItem('as_dealer_' + u);
    document.getElementById('dealerName').value = savedDealer || "";
    updateCartUI();
}

function persistCart() { if(currentU) localStorage.setItem('as_cart_' + currentU, JSON.stringify(cart)); }
function persistDealer() { if(currentU) localStorage.setItem('as_dealer_' + currentU, document.getElementById('dealerName').value); }
function logout() { localStorage.removeItem('as_active_user'); location.reload(); }

function searchProduct() {
    const q = document.getElementById('searchInput').value.toUpperCase().trim();
    if(!q) return;
    const matches = inventory.filter(i => (i.Product||"").toUpperCase().includes(q) || (i.Description||"").toUpperCase().includes(q));
    if(matches.length === 0) return showToast("Bulunamadƒ±!");
    groupedResults = {};
    matches.forEach(item => { const c = item.Product || item.Reference; if(!groupedResults[c]) groupedResults[c] = []; groupedResults[c].push(item); });
    renderResults();
}

function renderResults() {
    const area = document.getElementById('resultsArea'); area.innerHTML = "";
    Object.keys(groupedResults).forEach(code => {
        const g = groupedResults[code], f = g[0];
        const card = document.createElement('div'); card.className = 'product-card';
        card.onclick = () => openProductModal(code);
        card.innerHTML = `
            <img src="${f.ImageURL || ''}" class="product-img">
            <div class="product-info-wrapper">
                <p class="product-code-label">${code}</p>
                <p class="product-name-label">${f.Description}</p>
                <p style="font-size:10px; color:#bbb; margin-top:2px;">EAN: ${f.EAN || '-'}</p>
                <span style="font-size:16px; font-weight:800; color:#000; margin-top:10px; display:block;">${f['Tariff Price']} ${f['Currency']}</span>
            </div>`;
        area.appendChild(card);
    });
}

function openProductModal(code) {
    const g = groupedResults[code], f = g[0]; modalCode = code;
    document.getElementById('productModalImg').src = f.ImageURL || '';
    document.getElementById('pm-code').innerText = code;
    document.getElementById('pm-name').innerText = f.Description;
    document.getElementById('pm-ean').innerText = "Barkod / EAN: " + (f.EAN || '-');
    document.getElementById('pm-desc').innerText = f['Long Description'] || '';
    document.getElementById('pm-price').innerText = f['Tariff Price'] + " " + f['Currency'];
    document.getElementById('pm-sizes').innerHTML = g.map((item, idx) => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid #f0f0f0;">
            <span style="font-weight:700;">Beden: ${item['EUR Size']}</span>
            <input type="number" id="pm-qty-${idx}" class="pm-qty-inp" value="0" min="0" onfocus="if(this.value=='0')this.value=''" onblur="if(this.value=='')this.value='0'">
        </div>`).join('');
    document.getElementById('productModal').classList.add('open');
}

function _closeProductModal() { document.getElementById('productModal').classList.remove('open'); }

function addToCartFromModal() {
    const d = document.getElementById('dealerName').value.trim();
    if(!d) return showToast("‚ö†Ô∏è Bayi adƒ± girin!");
    let add = 0;
    groupedResults[modalCode].forEach((item, idx) => {
        const q = parseInt(document.getElementById(`pm-qty-${idx}`).value);
        if(q > 0) { cart.push({ ...item, qty: q, price: parseFloat(item['Tariff Price']), dealer: d }); add += q; }
    });
    if(add > 0) { 
        updateCartUI(); 
        persistCart(); 
        resetOrderFlow(); // Sepet deƒüi≈ütiyse onay akƒ±≈üƒ±nƒ± sƒ±fƒ±rla
        showToast(`‚úÖ ${add} √úr√ºn Eklendi`); 
        _closeProductModal(); 
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ YENƒ∞: Sƒ∞PARƒ∞≈û AKI≈ûI LOJƒ∞ƒûƒ∞ ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function resetOrderFlow() {
    document.getElementById('btnConfirmOrder').style.display = 'block';
    document.getElementById('postConfirmActions').style.display = 'none';
}

function confirmAndLockOrder() {
    const d = document.getElementById('dealerName').value.trim();
    if(!d) return showToast("‚ö†Ô∏è √ñnce Bayi Adƒ± Giriniz!");
    if(cart.length === 0) return showToast("‚ö†Ô∏è Sepet Bo≈ü!");

    // Ge√ßmi≈üe Kaydet (Betonlama)
    let h = JSON.parse(localStorage.getItem('as_history_' + currentU)) || [];
    h.unshift({ id: Date.now(), date: new Date().toLocaleString(), dealer: d, items: [...cart] });
    localStorage.setItem('as_history_' + currentU, JSON.stringify(h.slice(0, 50)));

    // Butonlarƒ± Deƒüi≈ütir
    document.getElementById('btnConfirmOrder').style.display = 'none';
    document.getElementById('postConfirmActions').style.display = 'flex';
    showToast("‚úì Sipari≈ü Onaylandƒ± ve Kaydedildi.");
}

function confirmClearCart() {
    if(confirm("Dƒ∞KKAT: Mevcut sepet temizlenecek. Yeni bir m√º≈üteriye mi ge√ßiyorsunuz?")) {
        cart = []; persistCart(); updateCartUI(); 
        resetOrderFlow();
        closeModal('cartModal');
        showToast("üóëÔ∏è Sepet Temizlendi.");
    }
}

function updateCartUI() {
    document.getElementById('cartBadge').innerText = cart.length;
    const total = cart.reduce((a, b) => a + (b.price * b.qty), 0);
    document.getElementById('cartTotal').innerText = total.toFixed(2) + " TL";
}

function openCart() {
    const list = document.getElementById('cartItems');
    if(cart.length === 0) { 
        list.innerHTML = "<p style='text-align:center;padding:20px;color:#888;'>Sepetiniz bo≈ü.</p>"; 
        resetOrderFlow();
    } else {
        const groups = {};
        cart.forEach(i => { const c = i.Product || i.Reference; if(!groups[c]) groups[c] = { name: i.Description, img: i.ImageURL, items: [] }; groups[c].items.push(i); });
        list.innerHTML = Object.keys(groups).map(c => `
            <div class="cart-group">
                <div class="cart-group-header">
                    <img src="${groups[c].img || ''}" class="cart-thumb" onerror="this.src='https://via.placeholder.com/60'">
                    <div><div style="font-size:11px;font-weight:800;color:var(--accent);">${c}</div><div style="font-weight:700;font-size:14px;">${groups[c].name}</div></div>
                </div>
                ${groups[c].items.map(it => `
                    <div style="display:flex;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #f9f9f9;align-items:center;">
                        <span style="font-size:13px;font-weight:600;">Beden: ${it['EUR Size']} - ${it.qty} Adet</span>
                        <i class="fas fa-trash" onclick="removeFromCart(${cart.indexOf(it)})" style="color:#ff4d4d;padding:5px;"></i>
                    </div>`).join('')}
            </div>`).join('');
    }
    document.getElementById('cartModal').style.display='block';
}

function removeFromCart(i) { 
    cart.splice(i, 1); 
    persistCart(); 
    updateCartUI(); 
    openCart(); 
    resetOrderFlow(); // √úr√ºn silindiyse tekrar onay gerekebilir
}

function saveAndExport() {
    const d = document.getElementById('dealerName').value;
    const ws = XLSX.utils.json_to_sheet(cart);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Siparis");
    XLSX.writeFile(wb, `Siparis_${d}.xlsx`);
}

function sendMail() {
    const btn = document.getElementById('btnMail'); btn.disabled = true; btn.innerText = "G√ñNDERƒ∞Lƒ∞YOR...";
    let table = `<table border="1" style="width:100%;border-collapse:collapse;"><tr><th>Kod</th><th>√úr√ºn</th><th>Beden</th><th>Adet</th></tr>`;
    cart.forEach(i => table += `<tr><td>${i.Product}</td><td>${i.Description}</td><td>${i['EUR Size']}</td><td>${i.qty}</td></tr>`);
    table += `</table>`;
    
    emailjs.send(EMAILJS_SVC, EMAILJS_TMP, { 
        manager: currentU.toUpperCase(), 
        dealer: document.getElementById('dealerName').value, 
        order_details: table,
        customer_email: FIXED_EMAILS + (document.getElementById('customerEmail').value ? ", " + document.getElementById('customerEmail').value : "")
    }).then(() => {
        showToast("‚úÖ Mail G√∂nderildi!"); 
    }).finally(()=> { btn.disabled = false; btn.innerText = "MAƒ∞L AT"; });
}

function openHistory() {
    const list = document.getElementById('historyList');
    const h = JSON.parse(localStorage.getItem('as_history_' + currentU)) || [];
    list.innerHTML = h.length ? h.map(o => `
        <div style="padding:15px; background:#f9f9f9; border-radius:15px; margin-bottom:10px; border-left:4px solid var(--accent);">
            <div style="font-weight:800;">${o.dealer}</div>
            <div style="font-size:12px;color:#888;">${o.date}</div>
            <div style="font-size:12px;margin-top:5px;">${o.items.length} Kalem √úr√ºn</div>
            <button onclick="downloadHist(${o.id})" style="margin-top:10px;background:var(--success);border:none;color:#fff;padding:6px 12px;border-radius:8px;font-size:11px;font-weight:700;">Excel ƒ∞ndir</button>
        </div>`).join('') : "<p style='text-align:center;padding:20px;color:#aaa;'>Hen√ºz ge√ßmi≈ü sipari≈ü yok.</p>";
    document.getElementById('historyModal').style.display = 'block';
}

function downloadHist(id) {
    const h = JSON.parse(localStorage.getItem('as_history_' + currentU)) || [];
    const o = h.find(x => x.id === id);
    const ws = XLSX.utils.json_to_sheet(o.items);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Siparis");
    XLSX.writeFile(wb, `Gecmis_${o.dealer}.xlsx`);
}

function toggleCamera() {
    const container = document.getElementById('reader-container');
    if(html5QrCode) { html5QrCode.stop(); html5QrCode = null; container.style.display='none'; return; }
    container.style.display='block';
    html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start({ facingMode: "environment" }, { fps: 20, qrbox: { width: 250, height: 100 } }, (txt) => {
        beep.play().catch(()=>{}); document.getElementById('searchInput').value = txt; searchProduct(); toggleCamera();
    });
}

function closeModal(id) { document.getElementById(id).style.display='none'; }
function showToast(m) { const t = document.getElementById("toast"); t.innerText = m; t.className = "show"; setTimeout(() => t.className = "", 3000); }
</script>
</body>
</html>