<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>As Spor - Showroom Sistemi</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <link rel="apple-touch-icon" href="icon-192.png">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root { --primary: #000000; --accent: #00AEEF; --bg: #f8f9fb; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding-bottom: 120px; color: #1a1a1a; }
        
        #debugStatus { background: #f39c12; color: white; padding: 10px; text-align: center; font-weight: bold; font-size: 14px; position: fixed; top: 0; left: 0; width: 100%; z-index: 9999; }
        
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary); z-index: 5000; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
        .login-box { background: white; width: 100%; max-width: 350px; padding: 40px 30px; border-radius: 24px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.4); }
        .login-input { width: 100%; padding: 15px; margin: 10px 0; border: 2px solid #eee; border-radius: 12px; outline: none; box-sizing: border-box; font-family: 'Inter'; font-size: 16px; }
        .login-btn { width: 100%; background: var(--accent); color: white; padding: 15px; border: none; border-radius: 12px; font-weight: 800; cursor: pointer; margin-top: 10px; font-size: 16px; transition: 0.2s; }
        .error-msg { color: #ff4d4d; font-size: 14px; font-weight: 600; margin-top: 15px; display: none; padding: 10px; background: #fff0f0; border-radius: 8px; }

        .header-hero { background: var(--primary); color: white; padding: 40px 20px 80px 20px; border-bottom: 6px solid var(--accent); }
        .main-container { max-width: 1200px; margin: 0 auto; padding: 0 15px; }
        .user-welcome-bar { background: white; padding: 15px 20px; border-radius: 18px; margin-top: -50px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: 10px; }
        
        .search-container { background: white; padding: 8px; border-radius: 18px; margin-top: 20px; display: flex; gap: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); }
        .search-field { flex: 1; border: none; padding-left: 15px; outline: none; font-size: 16px; font-family: 'Inter'; }
        
        /* BUTONLAR */
        .btn-scan { background: var(--primary); color: white; border: none; width: 55px; height: 50px; border-radius: 14px; cursor: pointer; font-size: 18px; }
        .btn-camera { background: var(--accent); color: white; border: none; width: 55px; height: 50px; border-radius: 14px; cursor: pointer; font-size: 20px; }
        
        /* KAMERA ALANI */
        #reader { width: 100%; margin-top: 15px; border-radius: 18px; overflow: hidden; display: none; border: 4px solid var(--accent); }

        /* GRID YAPISI */
        #resultsArea { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 25px; }
        @media (max-width: 768px) { #resultsArea { grid-template-columns: 1fr; } }

        /* ÃœrÃ¼n KartÄ± */
        .product-card { background: white; border-radius: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); overflow: hidden; border: 1px solid #eee; animation: fadein 0.5s; transition: transform 0.2s; display: flex; flex-direction: column; height: 100%; }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .product-img { width: 100%; height: 250px; object-fit: contain; background: #fff; padding: 10px; border-bottom: 1px solid #f0f0f0; }
        .product-info-wrapper { padding: 20px; flex-grow: 1; display: flex; flex-direction: column; }
        .price-tag { font-size: 22px; font-weight: 800; color: var(--accent); margin: 5px 0; display: block; }
        .info-box { background: #f9f9f9; padding: 10px; border-radius: 8px; font-size: 12px; color: #555; margin: 10px 0; display: none; }
        .stock-section { display: none; margin-top: 15px; border-top: 1px dashed #eee; padding-top: 10px; }
        .toggle-btn { text-align: center; color: white; font-weight: 700; font-size: 13px; padding: 12px; background: var(--accent); cursor: pointer; border-radius: 10px; margin-top: 10px; transition: 0.2s; }
        .toggle-btn:hover { opacity: 0.9; }
        .size-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f2f2f2; }
        .qty-control { display: flex; gap: 5px; align-items: center; }
        .btn-qty { width: 32px; height: 32px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; background: #f0f0f0; }
        .qty-input { width: 45px; text-align: center; border: 1px solid #ddd; border-radius: 8px; height: 32px; font-weight: 700; }
        .btn-add-cart { width:100%; background:black; color:white; border:none; padding:15px; border-radius:12px; margin-top:15px; font-weight:800; cursor:pointer; }
        
        .btn-history { background: #f0f0f0; color: #333; padding: 8px 15px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 12px; border: none; display: flex; align-items: center; gap: 5px; }
        .floating-cart { position: fixed; bottom: 30px; right: 20px; background: var(--accent); color: white; width: 65px; height: 65px; border-radius: 50%; display: flex; justify-content: center; align-items: center; box-shadow: 0 10px 25px rgba(0,174,239,0.4); z-index: 1000; cursor: pointer; }
        .cart-badge { position: absolute; top: -5px; right: -5px; background: #ff4d4d; color: white; border-radius: 50%; width: 24px; height: 24px; font-size: 12px; display: flex; justify-content: center; align-items: center; border: 2px solid white; font-weight: 800; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 6000; }
        .modal-content { background: white; margin: 5% auto; width: 95%; max-width: 550px; padding: 25px; border-radius: 24px; max-height: 85vh; overflow-y: auto; position: relative; }
        .history-item { background: #f9f9f9; padding: 15px; border-radius: 12px; margin-bottom: 10px; border-left: 4px solid var(--accent); display: flex; justify-content: space-between; align-items: center; }
        .history-info { font-size: 13px; color: #333; }
        .history-btn { background: #2ecc71; color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 12px; }
        .cart-item { display: flex; align-items: center; gap: 15px; padding: 12px 0; border-bottom: 1px solid #eee; }
        .cart-thumb { width: 60px; height: 60px; object-fit: contain; border-radius: 8px; background: #f9f9f9; }
        
        #toast { visibility: hidden; min-width: 250px; background: #000; color: #fff; text-align: center; border-radius: 12px; padding: 16px; position: fixed; z-index: 7000; left: 50%; bottom: 120px; transform: translateX(-50%); font-weight: 600; }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 120px; opacity: 1;} }
    </style>
</head>
<body>

<div id="debugStatus">Veriler YÃ¼kleniyor...</div>

<div id="loginOverlay">
    <div class="login-box">
        <h2 style="margin: 0; font-weight: 800;">AS SPOR</h2>
        <p style="color:#666; font-size:13px; margin-bottom:20px;">Showroom Personel GiriÅŸi</p>
        <input type="text" id="loginUser" class="login-input" placeholder="KullanÄ±cÄ± AdÄ± (Ã¶rn: lutfuozturk)" autocomplete="off">
        <input type="password" id="loginPass" class="login-input" placeholder="Åžifre">
        <button id="btnLogin" class="login-btn">GÄ°RÄ°Åž YAP</button>
        <div id="loginError" class="error-msg"></div>
    </div>
</div>

<div class="header-hero"><h1>AS SPOR</h1></div>
<div class="main-container">
    <div class="user-welcome-bar">
        <div><b>Sorumlu:</b> <span id="displayUserName">-</span></div>
        <div style="display:flex; gap:10px;">
            <button onclick="openHistory()" class="btn-history"><i class="fas fa-history"></i> GeÃ§miÅŸ SipariÅŸler</button>
            <button onclick="logout()" style="color:red; border:none; background:none; cursor:pointer; font-weight:700;">Ã‡IKIÅž</button>
        </div>
    </div>
    
    <input type="text" id="dealerName" class="login-input" style="margin-top:15px; background:white;" placeholder="Bayi AdÄ± (Zorunlu)">
    
    <div class="search-container">
        <input type="text" id="searchInput" class="search-field" placeholder="ÃœrÃ¼n Kodu Ara (Ã–rn: BKLITW25)">
        <button class="btn-scan" onclick="searchProduct()"><i class="fas fa-search"></i></button>
        <button class="btn-camera" onclick="toggleCamera()" style="margin-left:5px;"><i class="fas fa-camera"></i></button>
    </div>

    <div id="reader"></div>

    <div id="resultsArea"></div>

</div>

<div class="floating-cart" onclick="openCart()">
    <i class="fas fa-shopping-basket fa-lg"></i>
    <div id="cartBadge" class="cart-badge">0</div>
</div>

<div id="cartModal" class="modal">
    <div class="modal-content">
        <span onclick="closeCart()" style="float:right; cursor:pointer; font-size:28px;">&times;</span>
        <h2 style="margin-top:0; font-weight:800;">Sepetim</h2>
        <div id="cartItems"></div>
        <div style="margin-top:15px; text-align:right; font-size:18px; font-weight:800;">
            TOPLAM: <span id="cartTotal" style="color:var(--accent);">0.00</span>
        </div>
        <input type="text" id="customerEmail" class="login-input" style="margin-top:20px;" placeholder="MÃ¼ÅŸteri Maili (Opsiyonel)">
        <div style="display:flex; gap:12px; margin-top:20px;">
            <button onclick="saveAndExport()" style="flex:1; background:#2ecc71; color:white; border:none; padding:15px; border-radius:12px; font-weight:800;">EXCEL Ä°NDÄ°R</button>
            <button onclick="sendMail()" id="btnMail" style="flex:1; background:#000; color:white; border:none; padding:15px; border-radius:12px; font-weight:800;">TABLOYU MAÄ°L AT</button>
        </div>
    </div>
</div>

<div id="historyModal" class="modal">
    <div class="modal-content">
        <span onclick="document.getElementById('historyModal').style.display='none'" style="float:right; cursor:pointer; font-size:28px;">&times;</span>
        <h2 style="margin-top:0; font-weight:800;">SipariÅŸ GeÃ§miÅŸi</h2>
        <div id="historyList" style="margin-top:20px;"></div>
        <p style="color:#999; font-size:11px; text-align:center; margin-top:20px;">* GeÃ§miÅŸ sipariÅŸler sadece bu cihazda saklanÄ±r.</p>
    </div>
</div>

<div id="toast"></div>

<script>
    // --- 1. SABÄ°TLER ---
    const EMAILJS_SERVICE_ID = "service_qh7mngr";
    const EMAILJS_TEMPLATE_ID = "template_2e5jxvh";
    const EMAILJS_PUBLIC_KEY = "VSRTcl2JLxhmNWT4a";
    const FIXED_EMAILS = "emel@asspor.com, siparis@asspor.com";

    const USERS = {
        "adnankaya": { name: "Adnan Kaya", pass: "1234" },
        "cinargokce": { name: "Ã‡Ä±nar GÃ¶kÃ§e", pass: "1234" },
        "lutfuozturk": { name: "LÃ¼tfÃ¼ Ã–ztÃ¼rk", pass: "1234" },
        "meftunicay": { name: "Meftuni Ã‡ay", pass: "1234" },
        "muratturgut": { name: "Murat Turgut", pass: "1234" },
        "ozkanocak": { name: "Ã–zkan Ocak", pass: "1234" },
        "serkanmert": { name: "Serkan Mert", pass: "1234" },
        "admin": { name: "Test Admin", pass: "1234" }
    };

    // --- 2. SES VE KAMERA AYARLARI ---
    const beepSound = new Audio("data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU");
    let html5QrcodeScanner = null;

    let currentUser = null, inventory = [], cart = [];
    let groupedResults = {}; 
    let isDataLoaded = false;

    // --- 3. PWA (Mobil Uygulama) SERVICE WORKER ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
             // service-worker.js dosyasÄ± varsa kaydeder, yoksa hata vermez, sessizce geÃ§er
            navigator.serviceWorker.register('./service-worker.js').catch(err => console.log(err));
        });
    }

    // --- 4. GÄ°RÄ°Åž Ä°ÅžLEMLERÄ° ---
    window.checkLogin = function() {
        let rawUser = document.getElementById('loginUser').value.trim().toLowerCase().replace(/\s/g, ''); 
        const p = document.getElementById('loginPass').value;
        const errorBox = document.getElementById('loginError');

        if(USERS[rawUser] && USERS[rawUser].pass === p) { 
            errorBox.style.display = 'none';
            localStorage.setItem('activeUser', rawUser); 
            loginSuccess(rawUser); 
        } else { 
            errorBox.style.display = 'block';
            errorBox.innerText = "KullanÄ±cÄ± adÄ± veya ÅŸifre hatalÄ±!";
        }
    }

    window.loginSuccess = function(k) { 
        currentUser = USERS[k]; 
        document.getElementById('displayUserName').innerText = currentUser.name; 
        document.getElementById('loginOverlay').style.display = 'none'; 
    }

    // --- 5. YÃœKLEME ---
    window.onload = function() {
        (function(){ emailjs.init(EMAILJS_PUBLIC_KEY); })();

        const saved = localStorage.getItem('activeUser');
        if(saved && USERS[saved]) loginSuccess(saved);

        document.getElementById("btnLogin").onclick = checkLogin;
        document.getElementById("loginPass").addEventListener("keypress", function(e) { if (e.key === "Enter") checkLogin(); });
        document.getElementById("searchInput").addEventListener("keypress", function(e) { if (e.key === "Enter") { e.preventDefault(); searchProduct(); } });

        const debugEl = document.getElementById('debugStatus');
        debugEl.innerText = "Veriler Ä°ndiriliyor...";

        Papa.parse('data.csv', { 
            download: true, header: true, delimiter: ";", skipEmptyLines: 'greedy', 
            worker: false,
            complete: function(r) {
                inventory = r.data.filter(row => {
                    const str = Object.values(row).join('').trim();
                    return str.length > 3 && (row['Product'] || row['Reference']);
                });
                isDataLoaded = true;
                debugEl.style.backgroundColor = "#27ae60";
                debugEl.innerText = `Sistem HazÄ±r! (${inventory.length} ÃœrÃ¼n)`;
                setTimeout(() => { debugEl.style.display = 'none'; }, 3000);
            },
            error: function(err) {
                debugEl.style.backgroundColor = "red";
                debugEl.innerText = "HATA: Veri dosyasÄ± okunamadÄ±!";
            }
        });
    };

    function logout() { localStorage.removeItem('activeUser'); location.reload(); }

    // --- 6. KAMERA FONKSÄ°YONLARI ---
    window.toggleCamera = function() {
        const readerDiv = document.getElementById('reader');
        
        // AÃ§Ä±ksa kapat
        if (html5QrcodeScanner) {
            html5QrcodeScanner.clear();
            html5QrcodeScanner = null;
            readerDiv.style.display = 'none';
            return;
        }

        // KapalÄ±ysa aÃ§
        readerDiv.style.display = 'block';
        html5QrcodeScanner = new Html5QrcodeScanner(
            "reader", 
            { fps: 10, qrbox: { width: 250, height: 250 } },
            false
        );
        html5QrcodeScanner.render(onScanSuccess);
    }

    function onScanSuccess(decodedText) {
        // Ses Ã§al
        beepSound.play().catch(e => console.log("Ses hatasÄ± (tarayÄ±cÄ± izni gerekebilir)"));
        
        // Kodu kutuya yaz
        document.getElementById('searchInput').value = decodedText;
        
        // AramayÄ± tetikle
        searchProduct();
        
        // KamerayÄ± kapat ve bildirim ver
        toggleCamera();
        showToast("ðŸ“¸ Barkod Okundu: " + decodedText);
    }

    // --- 7. ARAMA VE LÄ°STELEME ---
    window.searchProduct = function() {
        if(!isDataLoaded) { showToast("Veriler yÃ¼kleniyor, bekleyin..."); return; }
        const q = document.getElementById('searchInput').value.toUpperCase().trim();
        if(!q) return;
        
        const allMatches = inventory.filter(i => {
            const code = i.Product || i.Reference || "";
            return code.toString().toUpperCase().includes(q) || (i.Description && i.Description.toUpperCase().includes(q));
        });

        if(allMatches.length === 0) {
            showToast("ÃœrÃ¼n bulunamadÄ±!");
            document.getElementById('resultsArea').innerHTML = "";
            return;
        }

        groupedResults = {};
        allMatches.forEach(item => {
            const uniqueCode = item.Product || item.Reference || "UNK";
            if(!groupedResults[uniqueCode]) groupedResults[uniqueCode] = [];
            groupedResults[uniqueCode].push(item);
        });

        renderResults();
        document.getElementById('searchInput').value = ""; // Aramadan sonra temizle
    }

    function renderResults() {
        const area = document.getElementById('resultsArea');
        area.innerHTML = ""; 

        Object.keys(groupedResults).forEach(code => {
            const group = groupedResults[code];
            const first = group[0]; 
            
            let rawPrice = first['Tariff Price'] || first['Base Price'] || "0";
            let currency = first['Currency'] || "TL";
            let displayPrice = `${rawPrice} ${currency}`;

            const cardDiv = document.createElement('div');
            cardDiv.className = 'product-card';
            
            let html = `
                <img src="${first.ImageURL || 'https://via.placeholder.com/400'}" class="product-img">
                <div class="product-info-wrapper">
                    <div>
                        <h3 style="margin:0; font-weight: 800; font-size:16px;">${first.Description || "Ä°simsiz"}</h3>
                        <p style="color:#666; font-weight: 600; margin:5px 0;">${code}</p>
                        <span class="price-tag">${displayPrice}</span>
                        
                        <span onclick="toggleInfo('${code}')" style="color:var(--accent); cursor:pointer; text-decoration:underline; font-size:12px; font-weight:700;">
                            <i class="fas fa-info-circle"></i> EAN & AÃ§Ä±klama GÃ¶ster
                        </span>
                        <div id="info-${code}" class="info-box">
                            <b>EAN:</b> ${first.EAN || "-"}<br>
                            <p style="margin-top:5px; line-height:1.4;">${first['Long Description'] || "AÃ§Ä±klama yok."}</p>
                        </div>
                    </div>

                    <div class="toggle-btn" onclick="toggleStock('${code}')">
                        BEDEN VE STOK GÃ–R <i class="fas fa-chevron-down"></i>
                    </div>

                    <div id="stock-${code}" class="stock-section">`;

            group.forEach((item, index) => {
                const stock = parseInt(item['Stock Quantity'] || 0);
                const size = item['EUR Size'] || item['Beden'] || "-";
                const inputId = `qty-${code}-${index}`;
                
                html += `
                    <div class="size-row">
                        <div><b>${size}</b><br><small style="color:#888;">Stok: ${stock}</small></div>
                        <div class="qty-control">
                            <button class="btn-qty" onclick="changeQty('${inputId}',-1)">-</button>
                            <input type="number" id="${inputId}" class="qty-input" value="0" min="0" max="${stock}" 
                                   onfocus="if(this.value=='0') this.value=''" 
                                   onblur="if(this.value=='') this.value='0'"
                                   oninput="if(this.value>${stock})this.value=${stock}">
                            <button class="btn-qty" style="background:var(--accent); color:white;" onclick="changeQty('${inputId}',1,${stock})">+</button>
                        </div>
                    </div>`;
            });

            html += `<button class="btn-add-cart" onclick="addToCart('${code}')">SEPETE EKLE</button>
                    </div>
                </div>`;
            
            cardDiv.innerHTML = html;
            area.appendChild(cardDiv);
        });
    }

    // --- 8. ETKÄ°LEÅžÄ°M VE SEPET ---
    window.toggleInfo = function(code) {
        const el = document.getElementById(`info-${code}`);
        el.style.display = el.style.display === 'block' ? 'none' : 'block';
    }

    window.toggleStock = function(code) {
        const el = document.getElementById(`stock-${code}`);
        el.style.display = el.style.display === 'block' ? 'none' : 'block';
    }

    window.changeQty = function(id, d, max) {
        const el = document.getElementById(id);
        if(!el) return;
        let v = (el.value === "" ? 0 : parseInt(el.value)) + d;
        if(v >= 0 && v <= max) el.value = v;
    }

    window.addToCart = function(code) {
        const d = document.getElementById('dealerName').value.trim();
        if(!d) { showToast("Bayi adÄ± zorunlu!"); return; }

        const group = groupedResults[code]; 
        if(!group) return;

        let addedCount = 0;
        const first = group[0];
        let rawPrice = first['Tariff Price'] || first['Base Price'] || "0";
        let priceVal = parseFloat(String(rawPrice).replace(',', '.'));
        let currency = first['Currency'] || "TL";

        group.forEach((item, index) => {
            const inputId = `qty-${code}-${index}`;
            const el = document.getElementById(inputId);
            const q = el.value === "" ? 0 : parseInt(el.value);
            
            if(q > 0) {
                cart.push({
                    img: item.ImageURL, code: item.Product || item.Reference, name: item.Description,
                    size: item['EUR Size'] || item['Beden'], qty: q, price: priceVal, currency: currency, dealer: d
                });
                addedCount += q;
                el.value = 0;
            }
        });

        if(addedCount > 0) { updateUI(); showToast(`${addedCount} adet sepete eklendi.`); } 
        else { showToast("LÃ¼tfen adet girin."); }
    }

    function updateUI() { 
        document.getElementById('cartBadge').innerText = cart.length; 
        let total = cart.reduce((acc, item) => acc + (item.price * item.qty), 0);
        document.getElementById('cartTotal').innerText = total.toFixed(2) + " " + (cart[0]?.currency || "");
    }

    // --- 9. GEÃ‡MÄ°Åž SÄ°PARÄ°ÅžLER (HISTORY) ---
    window.saveOrderToHistory = function(orderCart, dealer) {
        if(!orderCart || orderCart.length === 0) return;
        let total = orderCart.reduce((acc, item) => acc + (item.price * item.qty), 0);
        let totalQty = orderCart.reduce((acc, item) => acc + item.qty, 0);
        let currency = orderCart[0]?.currency || "TL";
        const orderData = {
            id: Date.now(),
            date: new Date().toLocaleDateString('tr-TR') + " " + new Date().toLocaleTimeString('tr-TR'),
            dealer: dealer,
            total: total.toFixed(2),
            currency: currency,
            qty: totalQty,
            items: JSON.parse(JSON.stringify(orderCart))
        };
        let history = JSON.parse(localStorage.getItem('orderHistory')) || [];
        history.unshift(orderData);
        if(history.length > 50) history.pop();
        localStorage.setItem('orderHistory', JSON.stringify(history));
    }

    window.openHistory = function() {
        const modal = document.getElementById('historyModal');
        const list = document.getElementById('historyList');
        const history = JSON.parse(localStorage.getItem('orderHistory')) || [];
        if(history.length === 0) {
            list.innerHTML = "<p style='text-align:center;'>HenÃ¼z geÃ§miÅŸ sipariÅŸ yok.</p>";
        } else {
            list.innerHTML = "";
            history.forEach(order => {
                list.innerHTML += `
                    <div class="history-item">
                        <div class="history-info">
                            <b>${order.dealer}</b><br>
                            <span style="color:#666;">${order.date}</span><br>
                            <span>${order.qty} Adet - <b>${order.total} ${order.currency}</b></span>
                        </div>
                        <button class="history-btn" onclick="downloadHistoryExcel(${order.id})"><i class="fas fa-file-excel"></i> Excel</button>
                    </div>`;
            });
        }
        modal.style.display = 'block';
    }

    window.downloadHistoryExcel = function(id) {
        const history = JSON.parse(localStorage.getItem('orderHistory')) || [];
        const order = history.find(o => o.id === id);
        if(order) {
            const ws = XLSX.utils.json_to_sheet(order.items);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Siparis");
            XLSX.writeFile(wb, `GecmisSiparis_${order.dealer}_${order.id}.xlsx`);
        }
    }

    // --- 10. EXCEL & MAIL ---
    window.saveAndExport = function() {
        saveOrderToHistory(cart, document.getElementById('dealerName').value);
        exportToExcel();
        showToast("Excel indirildi ve GeÃ§miÅŸe kaydedildi.");
    }

    window.exportToExcel = function() {
        const ws = XLSX.utils.json_to_sheet(cart); 
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Siparis");
        XLSX.writeFile(wb, `AsSpor_${document.getElementById('dealerName').value}.xlsx`);
    }

    window.sendMail = function() {
        const btn = document.getElementById('btnMail'); 
        const dealer = document.getElementById('dealerName').value;
        if(!dealer) { showToast("Bayi adÄ± giriniz!"); return; }

        btn.disabled = true; btn.innerText = "GÃ–NDERÄ°LÄ°YOR...";
        
        // 3 parantezli {{{order_details}}} kullandÄ±ÄŸÄ±n iÃ§in burada HTML tablo oluÅŸturuyoruz
        let tableHTML = `<table style="width:100%; border-collapse:collapse; font-family:Arial; font-size:12px;"><thead style="background:#000; color:#fff;"><tr><th style="padding:8px;">Kod</th><th style="padding:8px;">ÃœrÃ¼n</th><th style="padding:8px;">Beden</th><th style="padding:8px;">Adet</th><th style="padding:8px;">Toplam</th></tr></thead><tbody>`;
        let totalVal = 0; let currency = cart[0]?.currency || "";
        cart.forEach(i => {
            let rowTotal = i.price * i.qty; totalVal += rowTotal;
            tableHTML += `<tr style="border-bottom:1px solid #ddd;"><td style="padding:8px;">${i.code}</td><td style="padding:8px;">${i.name}</td><td style="padding:8px;">${i.size}</td><td style="padding:8px;">${i.qty}</td><td style="padding:8px;">${rowTotal.toFixed(2)}</td></tr>`;
        });
        tableHTML += `<tr style="background:#f0f0f0; font-weight:bold;"><td colspan="4" style="padding:8px; text-align:right;">GENEL TOPLAM:</td><td style="padding:8px;">${totalVal.toFixed(2)} ${currency}</td></tr></tbody></table>`;

        const params = { manager: currentUser.name, dealer: dealer, customer_email: FIXED_EMAILS + (document.getElementById('customerEmail').value ? ", " + document.getElementById('customerEmail').value : ""), order_details: tableHTML, total_qty: cart.length };
        
        emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, params).then(() => {
            saveOrderToHistory(cart, dealer);
            showToast("Mail GÃ¶nderildi ve Kaydedildi!"); 
            btn.disabled = false; btn.innerText = "TABLOYU MAÄ°L AT"; 
            cart = []; updateUI(); closeCart();
        }, (err) => { alert("Mail HatasÄ±!"); btn.disabled = false; });
    }

    // --- MODAL FONKSÄ°YONLARI ---
    window.openCart = function() {
        if(cart.length === 0) { showToast("Sepet boÅŸ!"); return; }
        const list = document.getElementById('cartItems'); list.innerHTML = "";
        cart.forEach((item, index) => {
            list.innerHTML += `
                <div class="cart-item">
                    <img src="${item.img || 'https://via.placeholder.com/60'}" class="cart-thumb">
                    <div style="flex:1">
                        <b>${item.code}</b><br><small>${item.size} - ${item.qty} Adet</small><br>
                        <b style="color:var(--accent)">${(item.price * item.qty).toFixed(2)} ${item.currency}</b>
                    </div>
                    <i class="fas fa-trash-alt" onclick="removeFromCart(${index})" style="color:red; cursor:pointer;"></i>
                </div>`;
        });
        updateUI();
        document.getElementById('cartModal').style.display = 'block';
    }

    window.removeFromCart = function(i) { cart.splice(i, 1); openCart(); if(cart.length===0) closeCart(); }
    window.closeCart = function() { document.getElementById('cartModal').style.display = 'none'; }
    window.showToast = function(m) { const t=document.getElementById("toast"); t.innerText=m; t.className="show"; setTimeout(()=>t.className="", 3000); }
</script>
</body>
</html>