<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>As Spor - Showroom Sistemi</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root { --primary: #000000; --accent: #00AEEF; --bg: #f8f9fb; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding-bottom: 120px; color: #1a1a1a; }
        
        #debugStatus { background: #f39c12; color: white; padding: 10px; text-align: center; font-weight: bold; font-size: 14px; position: fixed; top: 0; left: 0; width: 100%; z-index: 9999; }
        
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary); z-index: 5000; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
        .login-box { background: white; width: 100%; max-width: 350px; padding: 40px 30px; border-radius: 24px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.4); }
        .login-input { width: 100%; padding: 15px; margin: 10px 0; border: 2px solid #eee; border-radius: 12px; outline: none; box-sizing: border-box; font-family: 'Inter'; font-size: 16px; }
        .login-btn { width: 100%; background: var(--accent); color: white; padding: 15px; border: none; border-radius: 12px; font-weight: 800; cursor: pointer; margin-top: 10px; font-size: 16px; transition: 0.2s; }
        .error-msg { color: #ff4d4d; font-size: 14px; font-weight: 600; margin-top: 15px; display: none; padding: 10px; background: #fff0f0; border-radius: 8px; }

        .header-hero { background: var(--primary); color: white; padding: 40px 20px 80px 20px; border-bottom: 6px solid var(--accent); }
        .main-container { max-width: 1200px; margin: 0 auto; padding: 0 15px; }
        .user-welcome-bar { background: white; padding: 18px; border-radius: 18px; margin-top: -50px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); display: flex; align-items: center; justify-content: space-between; }
        
        .search-container { background: white; padding: 8px; border-radius: 18px; margin-top: 20px; display: flex; gap: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); }
        .search-field { flex: 1; border: none; padding-left: 15px; outline: none; font-size: 16px; font-family: 'Inter'; }
        .btn-scan { background: var(--primary); color: white; border: none; width: 55px; height: 50px; border-radius: 14px; cursor: pointer; font-size: 18px; }

        /* GRID YAPISI */
        #resultsArea {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }
        @media (max-width: 768px) { #resultsArea { grid-template-columns: 1fr; } }

        /* Ürün Kartı */
        .product-card { 
            background: white; border-radius: 20px; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.05); 
            overflow: hidden; border: 1px solid #eee; 
            animation: fadein 0.5s;
            transition: transform 0.2s;
            height: fit-content; /* Yükseklik içeriğe göre değişsin */
        }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        
        /* Tıklanabilir Alan (Header) */
        .card-header { cursor: pointer; padding-bottom: 10px; }
        .product-img { width: 100%; height: 250px; object-fit: contain; background: #fff; padding: 10px; border-bottom: 1px solid #f0f0f0; pointer-events: none; }
        .product-info-header { padding: 20px 20px 0 20px; pointer-events: none; }

        .price-tag { font-size: 22px; font-weight: 800; color: var(--accent); margin: 5px 0; display: block; }

        /* Açılır Kapanır Alan (Sizes) */
        .card-body { 
            display: none; /* Varsayılan Gizli */
            padding: 0 20px 20px 20px; 
            background: #fff;
            border-top: 1px dashed #eee;
        }

        .toggle-btn {
            text-align: center; color: var(--accent); font-weight: 700; font-size: 13px;
            padding: 10px; background: #f9f9f9; cursor: pointer; border-top: 1px solid #eee;
        }
        .toggle-btn:hover { background: #f0f0f0; }

        .size-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f2f2f2; }
        .qty-control { display: flex; gap: 5px; align-items: center; }
        .btn-qty { width: 32px; height: 32px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; background: #f0f0f0; }
        .qty-input { width: 45px; text-align: center; border: 1px solid #ddd; border-radius: 8px; height: 32px; font-weight: 700; }

        .btn-add-cart { width:100%; background:black; color:white; border:none; padding:15px; border-radius:12px; margin-top:15px; font-weight:800; cursor:pointer; }
        .btn-add-cart:active { transform: scale(0.98); }

        /* Sepet & Modal Standart */
        .floating-cart { position: fixed; bottom: 30px; right: 20px; background: var(--accent); color: white; width: 65px; height: 65px; border-radius: 50%; display: flex; justify-content: center; align-items: center; box-shadow: 0 10px 25px rgba(0,174,239,0.4); z-index: 1000; cursor: pointer; }
        .cart-badge { position: absolute; top: -5px; right: -5px; background: #ff4d4d; color: white; border-radius: 50%; width: 24px; height: 24px; font-size: 12px; display: flex; justify-content: center; align-items: center; border: 2px solid white; font-weight: 800; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 6000; }
        .modal-content { background: white; margin: 5% auto; width: 95%; max-width: 500px; padding: 25px; border-radius: 24px; max-height: 85vh; overflow-y: auto; position: relative; }
        .cart-item { display: flex; align-items: center; gap: 15px; padding: 12px 0; border-bottom: 1px solid #eee; }
        .cart-thumb { width: 60px; height: 60px; object-fit: contain; border-radius: 8px; background: #f9f9f9; }
        #toast { visibility: hidden; min-width: 250px; background: #000; color: #fff; text-align: center; border-radius: 12px; padding: 16px; position: fixed; z-index: 7000; left: 50%; bottom: 120px; transform: translateX(-50%); font-weight: 600; }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 120px; opacity: 1;} }
    </style>
</head>
<body>

<div id="debugStatus">Veriler Yükleniyor...</div>

<div id="loginOverlay">
    <div class="login-box">
        <h2 style="margin: 0; font-weight: 800;">AS SPOR</h2>
        <p style="color:#666; font-size:13px; margin-bottom:20px;">Showroom Personel Girişi</p>
        <input type="text" id="loginUser" class="login-input" placeholder="Kullanıcı Adı (örn: lutfuozturk)" autocomplete="off">
        <input type="password" id="loginPass" class="login-input" placeholder="Şifre">
        <button id="btnLogin" class="login-btn">GİRİŞ YAP</button>
        <div id="loginError" class="error-msg"></div>
    </div>
</div>

<div class="header-hero"><h1>AS SPOR</h1></div>
<div class="main-container">
    <div class="user-welcome-bar">
        <span><b>Sorumlu:</b> <span id="displayUserName">-</span></span>
        <button onclick="logout()" style="color:red; border:none; background:none; cursor:pointer; font-weight:700;">ÇIKIŞ</button>
    </div>
    
    <input type="text" id="dealerName" class="login-input" style="margin-top:15px; background:white;" placeholder="Bayi Adı (Zorunlu)">
    
    <div class="search-container">
        <input type="text" id="searchInput" class="search-field" placeholder="Ürün Kodu Ara (Örn: BKLITW25)">
        <button class="btn-scan" onclick="searchProduct()"><i class="fas fa-search"></i></button>
    </div>

    <div id="resultsArea"></div>

</div>

<div class="floating-cart" onclick="openCart()">
    <i class="fas fa-shopping-basket fa-lg"></i>
    <div id="cartBadge" class="cart-badge">0</div>
</div>

<div id="cartModal" class="modal">
    <div class="modal-content">
        <span onclick="closeCart()" style="float:right; cursor:pointer; font-size:28px;">&times;</span>
        <h2 style="margin-top:0; font-weight:800;">Sepetim</h2>
        <div id="cartItems"></div>
        <div style="margin-top:15px; text-align:right; font-size:18px; font-weight:800;">
            TOPLAM: <span id="cartTotal" style="color:var(--accent);">0.00</span>
        </div>
        <input type="text" id="customerEmail" class="login-input" style="margin-top:20px;" placeholder="Müşteri Maili (Opsiyonel)">
        <div style="display:flex; gap:12px; margin-top:20px;">
            <button onclick="exportToExcel()" style="flex:1; background:#2ecc71; color:white; border:none; padding:15px; border-radius:12px; font-weight:800;">EXCEL İNDİR</button>
            <button onclick="sendMail()" id="btnMail" style="flex:1; background:#000; color:white; border:none; padding:15px; border-radius:12px; font-weight:800;">TABLOYU MAİL AT</button>
        </div>
    </div>
</div>
<div id="toast"></div>

<script>
    const EMAILJS_SERVICE_ID = "service_qh7mngr";
    const EMAILJS_TEMPLATE_ID = "template_2e5jxvh";
    const EMAILJS_PUBLIC_KEY = "VSRTcl2JLxhmNWT4a";
    const FIXED_EMAILS = "emel@asspor.com, siparis@asspor.com";

    const USERS = {
        "adnankaya": { name: "Adnan Kaya", pass: "1234" },
        "cinargokce": { name: "Çınar Gökçe", pass: "1234" },
        "lutfuozturk": { name: "Lütfü Öztürk", pass: "1234" },
        "meftunicay": { name: "Meftuni Çay", pass: "1234" },
        "muratturgut": { name: "Murat Turgut", pass: "1234" },
        "ozkanocak": { name: "Özkan Ocak", pass: "1234" },
        "serkanmert": { name: "Serkan Mert", pass: "1234" },
        "admin": { name: "Test Admin", pass: "1234" }
    };

    let currentUser = null, inventory = [], cart = [];
    let groupedResults = {}; 
    let isDataLoaded = false;

    // --- GİRİŞ MANTIĞI ---
    window.checkLogin = function() {
        let rawUser = document.getElementById('loginUser').value.trim().toLowerCase().replace(/\s/g, ''); 
        const p = document.getElementById('loginPass').value;
        const errorBox = document.getElementById('loginError');

        if(USERS[rawUser] && USERS[rawUser].pass === p) { 
            errorBox.style.display = 'none';
            localStorage.setItem('activeUser', rawUser); 
            loginSuccess(rawUser); 
        } else { 
            errorBox.style.display = 'block';
            errorBox.innerText = "Kullanıcı adı veya şifre hatalı!";
        }
    }

    window.loginSuccess = function(k) { 
        currentUser = USERS[k]; 
        document.getElementById('displayUserName').innerText = currentUser.name; 
        document.getElementById('loginOverlay').style.display = 'none'; 
    }

    // --- YÜKLEME VE ARAMA ---
    window.onload = function() {
        (function(){ emailjs.init(EMAILJS_PUBLIC_KEY); })();

        const saved = localStorage.getItem('activeUser');
        if(saved && USERS[saved]) loginSuccess(saved);

        document.getElementById("btnLogin").onclick = checkLogin;
        document.getElementById("loginPass").addEventListener("keypress", function(e) { if (e.key === "Enter") checkLogin(); });
        document.getElementById("searchInput").addEventListener("keypress", function(e) { if (e.key === "Enter") { e.preventDefault(); searchProduct(); } });

        const debugEl = document.getElementById('debugStatus');
        debugEl.innerText = "Veriler İndiriliyor...";

        Papa.parse('data.csv', { 
            download: true, header: true, delimiter: ";", skipEmptyLines: 'greedy', 
            worker: false,
            complete: function(r) {
                inventory = r.data.filter(row => {
                    const str = Object.values(row).join('').trim();
                    return str.length > 3 && (row['Product'] || row['Reference']);
                });
                isDataLoaded = true;
                debugEl.style.backgroundColor = "#27ae60";
                debugEl.innerText = `Sistem Hazır! (${inventory.length} Ürün)`;
                setTimeout(() => { debugEl.style.display = 'none'; }, 3000);
            }
        });
    };

    function logout() { localStorage.removeItem('activeUser'); location.reload(); }

    function searchProduct() {
        if(!isDataLoaded) { showToast("Veriler yükleniyor, bekleyin..."); return; }
        const q = document.getElementById('searchInput').value.toUpperCase().trim();
        if(!q) return;
        
        const allMatches = inventory.filter(i => {
            const code = i.Product || i.Reference || "";
            return code.toString().toUpperCase().includes(q) || (i.Description && i.Description.toUpperCase().includes(q));
        });

        if(allMatches.length === 0) {
            showToast("Ürün bulunamadı!");
            document.getElementById('resultsArea').innerHTML = "";
            return;
        }

        groupedResults = {};
        allMatches.forEach(item => {
            const uniqueCode = item.Product || item.Reference || "UNK";
            if(!groupedResults[uniqueCode]) groupedResults[uniqueCode] = [];
            groupedResults[uniqueCode].push(item);
        });

        renderResults();
        document.getElementById('searchInput').value = "";
    }

    function renderResults() {
        const area = document.getElementById('resultsArea');
        area.innerHTML = ""; 

        Object.keys(groupedResults).forEach(code => {
            const group = groupedResults[code];
            const first = group[0]; 
            
            let rawPrice = first['Tariff Price'] || first['Base Price'] || "0";
            let currency = first['Currency'] || "TL";
            let displayPrice = `${rawPrice} ${currency}`;

            const cardDiv = document.createElement('div');
            cardDiv.className = 'product-card';
            
            // KART YAPISI: 
            // 1. HEADER (Tıklanabilir - Resmi ve İsim)
            // 2. BODY (Gizli - Bedenler ve Buton)
            // 3. TOGGLE BAR (Tıklanabilir - "Bedenleri Seç" yazısı)

            let html = `
                <div class="card-header" onclick="toggleSelection('${code}')">
                    <img src="${first.ImageURL || 'https://via.placeholder.com/400'}" class="product-img">
                    <div class="product-info-header">
                        <h3 style="margin:0; font-weight: 800; font-size:16px;">${first.Description || "İsimsiz"}</h3>
                        <p style="color:#666; font-weight: 600; margin:5px 0;">${code}</p>
                        <span class="price-tag">${displayPrice}</span>
                    </div>
                </div>

                <div class="toggle-btn" onclick="toggleSelection('${code}')">
                    BEDEN VE STOK GÖR <i class="fas fa-chevron-down"></i>
                </div>

                <div id="selection-${code}" class="card-body">
                    <div style="font-size:12px; color:#888; margin-bottom:10px;">
                         <b>EAN:</b> ${first.EAN || "-"}<br>
                         <span onclick="toggleDesc('${code}')" style="text-decoration:underline; cursor:pointer;">Uzun Açıklama</span>
                         <p id="desc-txt-${code}" style="display:none; margin-top:5px;">${first['Long Description']}</p>
                    </div>

                    <div class="size-list-container">`;

            group.forEach((item, index) => {
                const stock = parseInt(item['Stock Quantity'] || 0);
                const size = item['EUR Size'] || item['Beden'] || "-";
                const inputId = `qty-${code}-${index}`;
                
                html += `
                    <div class="size-row">
                        <div><b>${size}</b><br><small style="color:#888;">Stok: ${stock}</small></div>
                        <div class="qty-control">
                            <button class="btn-qty" onclick="changeQty('${inputId}',-1)">-</button>
                            <input type="number" id="${inputId}" class="qty-input" value="0" min="0" max="${stock}" 
                                   onfocus="if(this.value=='0') this.value=''" 
                                   onblur="if(this.value=='') this.value='0'"
                                   oninput="if(this.value>${stock})this.value=${stock}">
                            <button class="btn-qty" style="background:var(--accent); color:white;" onclick="changeQty('${inputId}',1,${stock})">+</button>
                        </div>
                    </div>`;
            });

            html += `</div>
                    <button class="btn-add-cart" onclick="addToCart('${code}')">SEPETE EKLE</button>
                </div>`;
            
            cardDiv.innerHTML = html;
            area.appendChild(cardDiv);
        });
    }

    // --- ETKİLEŞİM FONKSİYONLARI ---
    window.toggleSelection = function(code) {
        const el = document.getElementById(`selection-${code}`);
        // Aç/Kapa efekti
        if (el.style.display === "block") {
            el.style.display = "none";
        } else {
            // İstersen diğer açık olanları kapatabiliriz, ama şimdilik serbest bırakalım
            el.style.display = "block";
        }
    }

    window.toggleDesc = function(code) {
        const el = document.getElementById(`desc-txt-${code}`);
        el.style.display = el.style.display === 'block' ? 'none' : 'block';
    }

    window.changeQty = function(id, d, max) {
        const el = document.getElementById(id);
        if(!el) return;
        let v = (el.value === "" ? 0 : parseInt(el.value)) + d;
        if(v >= 0 && v <= max) el.value = v;
    }

    window.addToCart = function(code) {
        const d = document.getElementById('dealerName').value.trim();
        if(!d) { showToast("Bayi adı zorunlu!"); return; }

        const group = groupedResults[code]; 
        if(!group) return;

        let addedCount = 0;
        const first = group[0];
        let rawPrice = first['Tariff Price'] || first['Base Price'] || "0";
        let priceVal = parseFloat(String(rawPrice).replace(',', '.'));
        let currency = first['Currency'] || "TL";

        group.forEach((item, index) => {
            const inputId = `qty-${code}-${index}`;
            const el = document.getElementById(inputId);
            const q = el.value === "" ? 0 : parseInt(el.value);
            
            if(q > 0) {
                cart.push({
                    img: item.ImageURL, code: item.Product || item.Reference, name: item.Description,
                    size: item['EUR Size'] || item['Beden'], qty: q, price: priceVal, currency: currency, dealer: d
                });
                addedCount += q;
                el.value = 0;
            }
        });

        if(addedCount > 0) { 
            updateUI(); 
            showToast(`${addedCount} adet ürün sepete eklendi.`); 
            // İsteğe bağlı: ekledikten sonra kartı kapat
            // document.getElementById(`selection-${code}`).style.display = 'none';
        } else { 
            showToast("Lütfen adet girin."); 
        }
    }

    function updateUI() { 
        document.getElementById('cartBadge').innerText = cart.length; 
        let total = cart.reduce((acc, item) => acc + (item.price * item.qty), 0);
        document.getElementById('cartTotal').innerText = total.toFixed(2) + " " + (cart[0]?.currency || "");
    }

    window.openCart = function() {
        if(cart.length === 0) { showToast("Sepet boş!"); return; }
        const list = document.getElementById('cartItems'); list.innerHTML = "";
        cart.forEach((item, index) => {
            list.innerHTML += `
                <div class="cart-item">
                    <img src="${item.img || 'https://via.placeholder.com/60'}" class="cart-thumb">
                    <div style="flex:1">
                        <b>${item.code}</b><br><small>${item.size} - ${item.qty} Adet</small><br>
                        <b style="color:var(--accent)">${(item.price * item.qty).toFixed(2)} ${item.currency}</b>
                    </div>
                    <i class="fas fa-trash-alt" onclick="removeFromCart(${index})" style="color:red; cursor:pointer;"></i>
                </div>`;
        });
        updateUI();
        document.getElementById('cartModal').style.display = 'block';
    }

    window.removeFromCart = function(i) { cart.splice(i, 1); openCart(); if(cart.length===0) closeCart(); }
    window.closeCart = function() { document.getElementById('cartModal').style.display = 'none'; }

    window.sendMail = function() {
        const btn = document.getElementById('btnMail'); btn.disabled = true; btn.innerText = "GÖNDERİLİYOR...";
        let tableHTML = `<table style="width:100%; border-collapse:collapse; font-family:Arial; font-size:12px;"><thead style="background:#000; color:#fff;"><tr><th style="padding:8px;">Kod</th><th style="padding:8px;">Ürün</th><th style="padding:8px;">Beden</th><th style="padding:8px;">Adet</th><th style="padding:8px;">Toplam</th></tr></thead><tbody>`;
        let totalVal = 0; let currency = cart[0]?.currency || "";
        cart.forEach(i => {
            let rowTotal = i.price * i.qty; totalVal += rowTotal;
            tableHTML += `<tr style="border-bottom:1px solid #ddd;"><td style="padding:8px;">${i.code}</td><td style="padding:8px;">${i.name}</td><td style="padding:8px;">${i.size}</td><td style="padding:8px;">${i.qty}</td><td style="padding:8px;">${rowTotal.toFixed(2)}</td></tr>`;
        });
        tableHTML += `<tr style="background:#f0f0f0; font-weight:bold;"><td colspan="4" style="padding:8px; text-align:right;">GENEL TOPLAM:</td><td style="padding:8px;">${totalVal.toFixed(2)} ${currency}</td></tr></tbody></table>`;

        const params = { manager: currentUser.name, dealer: document.getElementById('dealerName').value, customer_email: FIXED_EMAILS + (document.getElementById('customerEmail').value ? ", " + document.getElementById('customerEmail').value : ""), order_details: tableHTML, total_qty: cart.length };
        emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, params).then(() => {
            showToast("Mail Gönderildi!"); btn.disabled = false; btn.innerText = "TABLOYU MAİL AT"; cart = []; updateUI(); closeCart();
        }, (err) => { alert("Hata!"); btn.disabled = false; });
    }

    window.exportToExcel = function() {
        const ws = XLSX.utils.json_to_sheet(cart); const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Siparis");
        XLSX.writeFile(wb, `AsSpor_${document.getElementById('dealerName').value}.xlsx`);
    }
    
    window.showToast = function(m) { const t=document.getElementById("toast"); t.innerText=m; t.className="show"; setTimeout(()=>t.className="", 3000); }
</script>
</body>
</html>