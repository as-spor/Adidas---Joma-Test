<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>As Spor - Showroom Sistemi</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <link rel="apple-touch-icon" href="icon-192.png">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <!-- FIX #1: Use the core html5-qrcode library (not the scanner wrapper) so we can access the raw video element for OCR -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js" type="text/javascript"></script>
    <script src="https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root { --primary: #000000; --accent: #00AEEF; --bg: #f8f9fb; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding-bottom: 120px; color: #1a1a1a; }
        
        #debugStatus { background: #f39c12; color: white; padding: 10px; text-align: center; font-weight: bold; font-size: 14px; position: fixed; top: 0; left: 0; width: 100%; z-index: 9999; }
        
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary); z-index: 5000; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
        .login-box { background: white; width: 100%; max-width: 350px; padding: 40px 30px; border-radius: 24px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.4); }
        .login-input { width: 100%; padding: 15px; margin: 10px 0; border: 2px solid #eee; border-radius: 12px; outline: none; box-sizing: border-box; font-family: 'Inter'; font-size: 16px; }
        .login-btn { width: 100%; background: var(--accent); color: white; padding: 15px; border: none; border-radius: 12px; font-weight: 800; cursor: pointer; margin-top: 10px; font-size: 16px; transition: 0.2s; }
        .error-msg { color: #ff4d4d; font-size: 14px; font-weight: 600; margin-top: 15px; display: none; padding: 10px; background: #fff0f0; border-radius: 8px; }

        .header-hero { background: var(--primary); color: white; padding: 40px 20px 80px 20px; border-bottom: 6px solid var(--accent); }
        .main-container { max-width: 1200px; margin: 0 auto; padding: 0 15px; }
        .user-welcome-bar { background: white; padding: 15px 20px; border-radius: 18px; margin-top: -50px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: 10px; }
        
        .search-container { background: white; padding: 8px; border-radius: 18px; margin-top: 20px; display: flex; gap: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); }
        .search-field { flex: 1; border: none; padding-left: 15px; outline: none; font-size: 16px; font-family: 'Inter'; }
        .btn-scan { background: var(--primary); color: white; border: none; width: 55px; height: 50px; border-radius: 14px; cursor: pointer; font-size: 18px; }
        .btn-camera { background: var(--accent); color: white; border: none; width: 55px; height: 50px; border-radius: 14px; cursor: pointer; font-size: 20px; }
        
        /* â”€â”€ SCANNER PANEL â”€â”€ */
        #reader-container {
            width: 100%; margin-top: 15px; display: none;
            background: #111; border-radius: 22px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.35);
        }

        /* Header bar inside scanner */
        .scanner-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 16px;
            background: #000;
        }
        .scanner-header span { color: #fff; font-weight: 700; font-size: 14px; letter-spacing: 0.5px; }
        .scanner-mode-tabs { display: flex; gap: 6px; }
        .mode-tab {
            padding: 5px 13px; border-radius: 20px; font-size: 12px; font-weight: 700;
            border: none; cursor: pointer; transition: 0.2s;
            background: #333; color: #aaa;
        }
        .mode-tab.active { background: var(--accent); color: #fff; }

        /* The actual camera viewport â€” compact height */
        #reader-viewport {
            position: relative;
            width: 100%;
            height: 220px;          /* fixed compact height */
            overflow: hidden;
            background: #000;
        }
        #reader {
            width: 100% !important;
            height: 220px !important;
            object-fit: cover;
        }
        /* Hide ALL html5-qrcode native UI */
        #reader__dashboard, #reader__status_span,
        #reader button, #reader select,
        #reader__header_message { display: none !important; }
        #reader video {
            width: 100% !important;
            height: 220px !important;
            object-fit: cover;
        }

        /* Dark overlay top + bottom, leaving only a narrow centre strip exposed */
        .scanner-overlay-top, .scanner-overlay-bottom {
            position: absolute; left: 0; width: 100%;
            background: rgba(0,0,0,0.55);
            pointer-events: none; z-index: 5;
        }
        .scanner-overlay-top    { top: 0;    height: 72px; }
        .scanner-overlay-bottom { bottom: 0; height: 72px; }

        /* Corner brackets */
        .scan-frame {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 240px; height: 56px;
            z-index: 8; pointer-events: none;
        }
        .scan-frame::before, .scan-frame::after,
        .scan-frame span::before, .scan-frame span::after {
            content: ''; position: absolute;
            width: 18px; height: 18px;
            border-color: var(--accent); border-style: solid;
        }
        .scan-frame::before  { top:0;    left:0;  border-width: 3px 0 0 3px; border-radius: 4px 0 0 0; }
        .scan-frame::after   { top:0;    right:0; border-width: 3px 3px 0 0; border-radius: 0 4px 0 0; }
        .scan-frame span::before { bottom:0; left:0;  border-width: 0 0 3px 3px; border-radius: 0 0 0 4px; }
        .scan-frame span::after  { bottom:0; right:0; border-width: 0 3px 3px 0; border-radius: 0 0 4px 0; }

        /* Animated laser line â€” stays strictly inside the scan-frame strip */
        .scanner-laser {
            position: absolute;
            left: calc(50% - 120px); width: 240px; height: 2px;
            background: linear-gradient(90deg, transparent, #ff3333, #ff6666, #ff3333, transparent);
            box-shadow: 0 0 8px 1px rgba(255,50,50,0.7);
            z-index: 9; pointer-events: none;
            animation: laserSweep 1.6s infinite ease-in-out;
        }
        @keyframes laserSweep {
            0%   { top: calc(50% - 28px); }
            50%  { top: calc(50% + 26px); }
            100% { top: calc(50% - 28px); }
        }

        /* Hint label inside viewport */
        .scan-hint {
            position: absolute; bottom: 78px; width: 100%;
            text-align: center; color: rgba(255,255,255,0.7);
            font-size: 11px; font-weight: 600; letter-spacing: 0.5px;
            z-index: 9; pointer-events: none;
        }

        /* Bottom controls */
        .ocr-controls {
            display: flex; gap: 0;
            border-top: 1px solid #222;
        }
        .btn-ocr-trigger {
            flex: 1; background: var(--accent); color: white; border: none;
            padding: 15px 10px; font-weight: 800; cursor: pointer;
            font-size: 13px; text-transform: uppercase; letter-spacing: 0.8px;
            transition: 0.2s;
        }
        .btn-ocr-trigger:active { opacity: 0.8; }
        .btn-close-camera {
            background: #222; color: #ccc; border: none;
            padding: 15px 18px; font-weight: 700; cursor: pointer;
            font-size: 13px; border-left: 1px solid #333;
            transition: 0.2s;
        }
        .btn-close-camera:active { background: #333; }

        #resultsArea { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 25px; }
        @media (max-width: 768px) { #resultsArea { grid-template-columns: 1fr; } }
        .product-card { background: white; border-radius: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); overflow: hidden; border: 1px solid #eee; animation: fadein 0.5s; transition: transform 0.2s; display: flex; flex-direction: column; height: 100%; }
        .product-img { width: 100%; height: 250px; object-fit: contain; background: #fff; padding: 10px; border-bottom: 1px solid #f0f0f0; }
        .product-info-wrapper { padding: 20px; flex-grow: 1; display: flex; flex-direction: column; }
        .price-tag { font-size: 22px; font-weight: 800; color: var(--accent); margin: 5px 0; display: block; }
        .stock-section { display: none; margin-top: 15px; border-top: 1px dashed #eee; padding-top: 10px; }
        .toggle-btn { text-align: center; color: white; font-weight: 700; font-size: 13px; padding: 12px; background: var(--accent); cursor: pointer; border-radius: 10px; margin-top: 10px; transition: 0.2s; }
        .size-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f2f2f2; }
        .qty-control { display: flex; gap: 5px; align-items: center; }
        .btn-qty { width: 32px; height: 32px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; background: #f0f0f0; }
        .qty-input { width: 45px; text-align: center; border: 1px solid #ddd; border-radius: 8px; height: 32px; font-weight: 700; }
        .btn-add-cart { width:100%; background:black; color:white; border:none; padding:15px; border-radius:12px; margin-top:15px; font-weight:800; cursor:pointer; }
        
        .floating-cart { position: fixed; bottom: 30px; right: 20px; background: var(--accent); color: white; width: 65px; height: 65px; border-radius: 50%; display: flex; justify-content: center; align-items: center; box-shadow: 0 10px 25px rgba(0,174,239,0.4); z-index: 1000; cursor: pointer; }
        .cart-badge { position: absolute; top: -5px; right: -5px; background: #ff4d4d; color: white; border-radius: 50%; width: 24px; height: 24px; font-size: 12px; display: flex; justify-content: center; align-items: center; border: 2px solid white; font-weight: 800; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 6000; }
        .modal-content { background: white; margin: 5% auto; width: 95%; max-width: 550px; padding: 25px; border-radius: 24px; max-height: 85vh; overflow-y: auto; position: relative; }
        #toast { visibility: hidden; min-width: 250px; background: #000; color: #fff; text-align: center; border-radius: 12px; padding: 16px; position: fixed; z-index: 7000; left: 50%; bottom: 120px; transform: translateX(-50%); font-weight: 600; }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 120px; opacity: 1;} }
        @keyframes fadeout { from {opacity: 1;} to {opacity: 0;} }
    </style>
</head>
<body>

<div id="debugStatus">Veriler YÃ¼kleniyor...</div>

<div id="loginOverlay">
    <div class="login-box">
        <h2 style="margin: 0; font-weight: 800;">AS SPOR</h2>
        <p style="color:#666; font-size:13px; margin-bottom:20px;">Showroom Personel GiriÅŸi</p>
        <input type="text" id="loginUser" class="login-input" placeholder="KullanÄ±cÄ± AdÄ±" autocomplete="off">
        <input type="password" id="loginPass" class="login-input" placeholder="Åžifre">
        <button onclick="checkLogin()" class="login-btn">GÄ°RÄ°Åž YAP</button>
        <div id="loginError" class="error-msg"></div>
    </div>
</div>

<div class="header-hero"><h1>AS SPOR</h1></div>
<div class="main-container">
    <div class="user-welcome-bar">
        <div><b>Sorumlu:</b> <span id="displayUserName">-</span></div>
        <div style="display:flex; gap:10px;">
            <button onclick="openHistory()" style="background:#eee; border:none; padding:8px 12px; border-radius:8px; font-weight:600; cursor:pointer; font-size:12px;"><i class="fas fa-history"></i> GeÃ§miÅŸ</button>
            <button onclick="logout()" style="color:red; border:none; background:none; cursor:pointer; font-weight:700;">Ã‡IKIÅž</button>
        </div>
    </div>
    
    <input type="text" id="dealerName" class="login-input" style="margin-top:15px; background:white;" placeholder="Bayi AdÄ± (Zorunlu)">
    
    <div class="search-container">
        <input type="text" id="searchInput" class="search-field" placeholder="ÃœrÃ¼n Kodu Ara (Ã–rn: BKLITW25)">
        <button class="btn-scan" onclick="searchProduct()"><i class="fas fa-search"></i></button>
        <button class="btn-camera" onclick="toggleCamera()"><i class="fas fa-camera"></i></button>
    </div>

    <div id="reader-container">
        <!-- Header: title + mode tabs -->
        <div class="scanner-header">
            <span><i class="fas fa-camera" style="color:var(--accent);"></i> &nbsp;TARAYICI</span>
            <div class="scanner-mode-tabs">
                <button class="mode-tab active" id="tab-barcode" onclick="setMode('barcode')"><i class="fas fa-barcode"></i> Barkod</button>
                <button class="mode-tab"        id="tab-ocr"     onclick="setMode('ocr')"><i class="fas fa-font"></i> YazÄ±</button>
            </div>
        </div>

        <!-- Compact camera viewport -->
        <div id="reader-viewport">
            <div id="reader"></div>

            <!-- Dark top/bottom overlays to isolate one line -->
            <div class="scanner-overlay-top"></div>
            <div class="scanner-overlay-bottom"></div>

            <!-- Corner brackets -->
            <div class="scan-frame"><span></span></div>

            <!-- Animated laser -->
            <div class="scanner-laser"></div>

            <!-- Hint text -->
            <div class="scan-hint" id="scanHint">Barkodu Ã§erÃ§eveye hizalayÄ±n</div>
        </div>

        <!-- Bottom action bar -->
        <div class="ocr-controls">
            <button class="btn-ocr-trigger" id="btnOcrAction" onclick="captureOCR()" style="display:none;">
                <i class="fas fa-camera"></i> &nbsp;YAZIYI TARA
            </button>
            <button class="btn-close-camera" onclick="toggleCamera()">
                <i class="fas fa-times"></i> &nbsp;KAPAT
            </button>
        </div>
    </div>

    <div id="resultsArea"></div>
</div>

<div class="floating-cart" onclick="openCart()">
    <i class="fas fa-shopping-basket fa-lg"></i>
    <div id="cartBadge" class="cart-badge">0</div>
</div>

<div id="cartModal" class="modal">
    <div class="modal-content">
        <span onclick="closeCart()" style="float:right; cursor:pointer; font-size:28px;">&times;</span>
        <h2 style="margin:0; font-weight:800;">Sepetim</h2>
        <div id="cartItems"></div>
        <div style="margin-top:15px; text-align:right; font-size:18px; font-weight:800;">TOPLAM: <span id="cartTotal" style="color:var(--accent);">0.00</span></div>
        <input type="text" id="customerEmail" class="login-input" style="margin-top:20px;" placeholder="MÃ¼ÅŸteri Maili (Opsiyonel)">
        <div style="display:flex; gap:12px; margin-top:20px;">
            <button onclick="saveAndExport()" style="flex:1; background:#2ecc71; color:white; border:none; padding:15px; border-radius:12px; font-weight:800; cursor:pointer;">EXCEL Ä°NDÄ°R</button>
            <button onclick="sendMail()" id="btnMail" style="flex:1; background:#000; color:white; border:none; padding:15px; border-radius:12px; font-weight:800; cursor:pointer;">MAÄ°L AT</button>
        </div>
    </div>
</div>

<div id="historyModal" class="modal">
    <div class="modal-content">
        <span onclick="document.getElementById('historyModal').style.display='none'" style="float:right; cursor:pointer; font-size:28px;">&times;</span>
        <h2 style="margin:0; font-weight:800;">SipariÅŸ GeÃ§miÅŸi</h2>
        <div id="historyList"></div>
    </div>
</div>

<div id="toast"></div>

<script>
    // --- 1. PERSONEL VE SABÄ°TLER ---
    const EMAILJS_SERVICE_ID = "service_qh7mngr";
    const EMAILJS_TEMPLATE_ID = "template_2e5jxvh";
    const EMAILJS_PUBLIC_KEY = "VSRTcl2JLxhmNWT4a";
    const FIXED_EMAILS = "emel@asspor.com, siparis@asspor.com";

    const USERS = {
        "adnankaya": { name: "Adnan Kaya", pass: "1234" },
        "cinargokce": { name: "Ã‡Ä±nar GÃ¶kÃ§e", pass: "1234" },
        "lutfuozturk": { name: "LÃ¼tfÃ¼ Ã–ztÃ¼rk", pass: "1234" },
        "meftunicay": { name: "Meftuni Ã‡ay", pass: "1234" },
        "muratturgut": { name: "Murat Turgut", pass: "1234" },
        "ozkanocak": { name: "Ã–zkan Ocak", pass: "1234" },
        "serkanmert": { name: "Serkan Mert", pass: "1234" },
        "admin": { name: "Test Admin", pass: "1234" }
    };

    const beepSound = new Audio("https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3");
    
    // FIX #5: Use Html5Qrcode (low-level class) instead of Html5QrcodeScanner
    // Html5QrcodeScanner wraps the video in shadow DOM â€” you can't grab it for OCR canvas capture.
    // Html5Qrcode gives direct camera access AND barcode scanning together.
    let html5QrCode = null;
    let isCameraRunning = false;
    let scanMode = 'barcode';
    let currentUser = null, inventory = [], cart = [], groupedResults = {}, isDataLoaded = false;

    // --- 2. BAÅžLATMA ---
    window.onload = function() {
        emailjs.init(EMAILJS_PUBLIC_KEY);
        const saved = localStorage.getItem('activeUser');
        if(saved && USERS[saved]) loginSuccess(saved);

        Papa.parse('data.csv', {
            download: true, header: true, delimiter: ";", skipEmptyLines: 'greedy',
            complete: (r) => {
                inventory = r.data.filter(row => row['Product'] || row['Reference']);
                isDataLoaded = true;
                document.getElementById('debugStatus').style.display = 'none';
            }
        });

        document.getElementById("searchInput").addEventListener("keypress", (e) => {
            if (e.key === "Enter") searchProduct();
        });
    };

    function checkLogin() {
        let u = document.getElementById('loginUser').value.trim().toLowerCase().replace(/\s/g, '');
        let p = document.getElementById('loginPass').value;
        if(USERS[u] && USERS[u].pass === p) {
            localStorage.setItem('activeUser', u);
            loginSuccess(u);
        } else {
            document.getElementById('loginError').style.display = 'block';
            document.getElementById('loginError').innerText = "HatalÄ± giriÅŸ!";
        }
    }

    function loginSuccess(k) {
        currentUser = USERS[k];
        document.getElementById('displayUserName').innerText = currentUser.name;
        document.getElementById('loginOverlay').style.display = 'none';
    }
    function logout() { localStorage.removeItem('activeUser'); location.reload(); }

    // --- 3. KAMERA, BARKOD VE OCR ---
    let scanMode = 'barcode'; // 'barcode' | 'ocr'

    window.setMode = function(mode) {
        scanMode = mode;
        document.getElementById('tab-barcode').classList.toggle('active', mode === 'barcode');
        document.getElementById('tab-ocr').classList.toggle('active', mode === 'ocr');
        document.getElementById('btnOcrAction').style.display = mode === 'ocr' ? 'flex' : 'none';
        document.getElementById('scanHint').innerText = mode === 'barcode'
            ? 'Barkodu Ã§erÃ§eveye hizalayÄ±n'
            : 'ÃœrÃ¼n kodunu Ã§erÃ§eveye hizalayÄ±n, sonra TARA\'ya bas';
    };

    window.toggleCamera = async function() {
        const container = document.getElementById('reader-container');
        if (isCameraRunning && html5QrCode) {
            try { await html5QrCode.stop(); html5QrCode.clear(); } catch(e) { console.warn(e); }
            isCameraRunning = false;
            container.style.display = 'none';
            return;
        }

        container.style.display = 'block';
        setMode('barcode'); // always start in barcode mode
        html5QrCode = new Html5Qrcode("reader");

        const config = {
            fps: 20,
            // Narrow box = reads ONE line only, won't bleed into neighbouring text
            qrbox: { width: 240, height: 52 },
            aspectRatio: 16/9,
            formatsToSupport: [
                Html5QrcodeSupportedFormats.EAN_13,
                Html5QrcodeSupportedFormats.EAN_8,
                Html5QrcodeSupportedFormats.CODE_128,
                Html5QrcodeSupportedFormats.CODE_39,
                Html5QrcodeSupportedFormats.QR_CODE,
                Html5QrcodeSupportedFormats.DATA_MATRIX
            ]
        };

        try {
            await html5QrCode.start(
                { facingMode: "environment" },
                config,
                async (decodedText) => {
                    // Only auto-capture in barcode mode; in OCR mode user presses the button
                    if (scanMode !== 'barcode') return;
                    beepSound.play().catch(() => {});
                    document.getElementById('searchInput').value = decodedText;
                    searchProduct();
                    showToast("ðŸ“¸ Barkod: " + decodedText);
                    try { await html5QrCode.stop(); html5QrCode.clear(); } catch(e) {}
                    isCameraRunning = false;
                    container.style.display = 'none';
                },
                () => {} // frame errors â€” ignore silently
            );
            isCameraRunning = true;
        } catch(err) {
            showToast("Kamera aÃ§Ä±lamadÄ±: " + err);
            container.style.display = 'none';
        }
    };

    window.captureOCR = async function() {
        const video = document.querySelector('#reader video');
        if (!video || !isCameraRunning) return showToast("Kamera aktif deÄŸil!");
        if (video.readyState < 2) return showToast("Kamera henÃ¼z hazÄ±r deÄŸil, tekrar dene.");

        showToast("ðŸ” Analiz ediliyor...");

        // Crop only the centre strip that the user sees (same proportions as the scan frame)
        const vw = video.videoWidth, vh = video.videoHeight;
        const stripH = Math.round(vh * 0.22); // ~22% of height = one narrow line
        const stripY = Math.round((vh - stripH) / 2);

        const canvas = document.createElement('canvas');
        canvas.width = vw; canvas.height = stripH;
        canvas.getContext('2d').drawImage(video, 0, stripY, vw, stripH, 0, 0, vw, stripH);

        try {
            const result = await Tesseract.recognize(canvas, 'eng', {
                tessedit_pageseg_mode: '8',  // single-word mode
                tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'
            });
            const cleaned = result.data.text.trim().toUpperCase().replace(/[^A-Z0-9]/g, '');
            if (cleaned && cleaned.length >= 4) {
                beepSound.play().catch(() => {});
                document.getElementById('searchInput').value = cleaned;
                searchProduct();
                try { await html5QrCode.stop(); html5QrCode.clear(); } catch(e) {}
                isCameraRunning = false;
                document.getElementById('reader-container').style.display = 'none';
                showToast("ðŸ“ AlgÄ±lanan: " + cleaned);
            } else {
                showToast("OkunamadÄ± â€” kodu Ã§erÃ§eveye yaklaÅŸtÄ±r ve tekrar dene.");
            }
        } catch(e) {
            showToast("OCR HatasÄ±: " + e.message);
        }
    };

    // --- 4. ARAMA VE SEPET ---
    function searchProduct() {
        const q = document.getElementById('searchInput').value.toUpperCase().trim();
        if(!q) return;
        const matches = inventory.filter(i => (i.Product||"").toUpperCase().includes(q) || (i.Description||"").toUpperCase().includes(q));
        if(matches.length === 0) return showToast("ÃœrÃ¼n bulunamadÄ±!");
        groupedResults = {};
        matches.forEach(item => {
            const code = item.Product || item.Reference;
            if(!groupedResults[code]) groupedResults[code] = [];
            groupedResults[code].push(item);
        });
        renderResults();
        document.getElementById('searchInput').value = "";
    }

    function renderResults() {
        const area = document.getElementById('resultsArea');
        area.innerHTML = "";
        Object.keys(groupedResults).forEach(code => {
            const group = groupedResults[code], first = group[0];
            const card = document.createElement('div');
            card.className = 'product-card';
            card.innerHTML = `
                <img src="${first.ImageURL || ''}" class="product-img">
                <div class="product-info-wrapper">
                    <h3>${first.Description}</h3>
                    <p>${code}</p>
                    <span class="price-tag">${first['Tariff Price']} ${first['Currency']}</span>
                    <div class="toggle-btn" onclick="toggleStock('${code}')">BEDEN VE STOK GÃ–R</div>
                    <div id="stock-${code}" class="stock-section">
                        ${group.map((item, idx) => `
                            <div class="size-row">
                                <b>${item['EUR Size']} (Stok: ${item['Stock Quantity']})</b>
                                <div class="qty-control">
                                    <button class="btn-qty" onclick="changeQty('qty-${code}-${idx}',-1)">-</button>
                                    <input type="number" id="qty-${code}-${idx}" class="qty-input" value="0" min="0">
                                    <button class="btn-qty" onclick="changeQty('qty-${code}-${idx}',1,${item['Stock Quantity']})">+</button>
                                </div>
                            </div>`).join('')}
                        <button class="btn-add-cart" onclick="addToCart('${code}')">SEPETE EKLE</button>
                    </div>
                </div>`;
            area.appendChild(card);
        });
    }

    window.toggleStock = (c) => { const el = document.getElementById(`stock-${c}`); el.style.display = el.style.display==='block' ? 'none' : 'block'; };
    window.changeQty = (id, d, m) => { const el = document.getElementById(id); let v = parseInt(el.value)+d; if(v>=0 && (!m || v<=m)) el.value=v; };

    window.addToCart = (code) => {
        const d = document.getElementById('dealerName').value.trim();
        if(!d) return showToast("Bayi adÄ± giriniz!");
        let added = 0;
        groupedResults[code].forEach((item, idx) => {
            const q = parseInt(document.getElementById(`qty-${code}-${idx}`).value);
            if(q > 0) { cart.push({ ...item, qty: q, price: parseFloat(item['Tariff Price']), dealer: d }); added += q; document.getElementById(`qty-${code}-${idx}`).value = 0; }
        });
        if(added > 0) { updateUI(); showToast("Sepete Eklendi."); }
    };

    function updateUI() {
        document.getElementById('cartBadge').innerText = cart.length;
        const total = cart.reduce((a, b) => a + (b.price * b.qty), 0);
        document.getElementById('cartTotal').innerText = total.toFixed(2) + " " + (cart[0]?.Currency || "TL");
    }

    // --- 5. EXCEL, MAIL VE GEÃ‡MÄ°Åž ---
    function saveAndExport() {
        if(cart.length === 0) return;
        saveToHistory(cart, document.getElementById('dealerName').value);
        const ws = XLSX.utils.json_to_sheet(cart);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Siparis");
        XLSX.writeFile(wb, `Siparis_${document.getElementById('dealerName').value}.xlsx`);
    }

    function sendMail() {
        const btn = document.getElementById('btnMail');
        btn.disabled = true; btn.innerText = "GÃ–NDERÄ°LÄ°YOR...";
        let table = `<table border="1" style="width:100%; border-collapse:collapse;"><tr><th>Kod</th><th>ÃœrÃ¼n</th><th>Beden</th><th>Adet</th></tr>`;
        cart.forEach(i => table += `<tr><td>${i.Product}</td><td>${i.Description}</td><td>${i['EUR Size']}</td><td>${i.qty}</td></tr>`);
        table += `</table>`;
        const params = {
            manager: currentUser.name,
            dealer: document.getElementById('dealerName').value,
            customer_email: FIXED_EMAILS + (document.getElementById('customerEmail').value ? ", " + document.getElementById('customerEmail').value : ""),
            order_details: table,
            total_qty: cart.length
        };
        emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, params).then(() => {
            saveToHistory(cart, params.dealer);
            showToast("GÃ¶nderildi!");
            btn.disabled = false; btn.innerText = "MAÄ°L AT";
            cart = []; updateUI(); closeCart();
        });
    }

    function saveToHistory(c, d) {
        let h = JSON.parse(localStorage.getItem('orderHistory')) || [];
        h.unshift({ id: Date.now(), date: new Date().toLocaleString(), dealer: d, items: c });
        localStorage.setItem('orderHistory', JSON.stringify(h.slice(0, 50)));
    }

    window.openHistory = () => {
        const list = document.getElementById('historyList');
        const h = JSON.parse(localStorage.getItem('orderHistory')) || [];
        list.innerHTML = h.length
            ? h.map(o => `<div style="padding:10px; background:#f9f9f9; border-radius:10px; margin-bottom:5px;"><div><b>${o.dealer}</b><br><small>${o.date}</small></div><button onclick="downloadHist(${o.id})" style="background:#2ecc71; border:none; color:white; padding:5px 10px; border-radius:5px; float:right;">Excel</button></div>`).join('')
            : "GeÃ§miÅŸ yok.";
        document.getElementById('historyModal').style.display = 'block';
    };

    window.downloadHist = (id) => {
        const o = JSON.parse(localStorage.getItem('orderHistory')).find(o => o.id === id);
        const ws = XLSX.utils.json_to_sheet(o.items);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Siparis");
        XLSX.writeFile(wb, `Gecmis_${o.dealer}.xlsx`);
    };

    window.openCart = () => {
        const list = document.getElementById('cartItems');
        list.innerHTML = cart.map((i, idx) => `<div style="padding:10px; border-bottom:1px solid #eee;"><b>${i.Product}</b> (${i.qty} Adet) <span onclick="remCart(${idx})" style="color:red; float:right; cursor:pointer;">Sil</span></div>`).join('');
        document.getElementById('cartModal').style.display = 'block';
    };
    window.remCart = (i) => { cart.splice(i, 1); openCart(); updateUI(); };
    window.closeCart = () => document.getElementById('cartModal').style.display = 'none';
    window.showToast = (m) => { const t = document.getElementById("toast"); t.innerText = m; t.className = "show"; setTimeout(() => t.className = "", 3000); };
</script>
</body>
</html>
