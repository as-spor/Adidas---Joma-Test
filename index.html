<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>As Spor - Showroom Sistemi</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <link rel="apple-touch-icon" href="icon-192.png">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root { --primary: #000; --accent: #00AEEF; --bg: #f8f9fb; --radius: 18px; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding-bottom: 160px; color: #1a1a1a; }

        /* â”€â”€ STATUS â”€â”€ */
        #debugStatus {
            background: #f39c12; color: #fff; padding: 10px; text-align: center;
            font-weight: 700; font-size: 14px; position: fixed; top: 0; left: 0;
            width: 100%; z-index: 9999; transition: background 0.4s;
        }

        /* â”€â”€ LOGIN â”€â”€ */
        #loginOverlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: var(--primary); z-index: 10000;
            display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px;
        }
        .login-box {
            background: #fff; width: 100%; max-width: 350px;
            padding: 40px 30px; border-radius: 24px; text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
        }
        .login-input {
            width: 100%; padding: 15px; margin: 10px 0;
            border: 2px solid #eee; border-radius: 12px; outline: none;
            font-family: 'Inter'; font-size: 16px; transition: border-color 0.2s;
        }
        .login-input:focus { border-color: var(--accent); }
        .login-btn {
            width: 100%; background: var(--accent); color: #fff;
            padding: 15px; border: none; border-radius: 12px;
            font-weight: 800; cursor: pointer; margin-top: 10px; font-size: 16px;
        }
        #loginError { color: red; display: none; margin-top: 10px; font-weight: 700; }

        /* â”€â”€ LAYOUT â”€â”€ */
        .header-hero { background: var(--primary); color: #fff; padding: 50px 20px 80px; border-bottom: 6px solid var(--accent); }
        .main-container { max-width: 1200px; margin: 0 auto; padding: 0 15px; }
        .user-welcome-bar {
            background: #fff; padding: 15px 20px; border-radius: var(--radius);
            margin-top: -50px; box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            display: flex; align-items: center; justify-content: space-between;
        }

        /* â”€â”€ SEARCH â”€â”€ */
        .search-container {
            background: #fff; padding: 8px; border-radius: var(--radius);
            margin-top: 20px; display: flex; gap: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.04);
        }
        .search-field { flex: 1; border: none; padding-left: 15px; outline: none; font-size: 16px; font-family: 'Inter'; }
        .btn-scan   { background: var(--primary); color: #fff; border: none; width: 55px; height: 50px; border-radius: 14px; cursor: pointer; font-size: 18px; }
        .btn-camera { background: var(--accent);  color: #fff; border: none; width: 55px; height: 50px; border-radius: 14px; cursor: pointer; font-size: 20px; }

        /* â”€â”€ SCANNER â”€â”€ */
        #reader-container { width: 100%; margin-top: 15px; display: none; background: #111; border-radius: 22px; overflow: hidden; }
        #reader-viewport { position: relative; width: 100%; height: 220px; background: #000; overflow: hidden; }
        #reader { width: 100% !important; height: 220px !important; }
        #reader video { width: 100% !important; height: 220px !important; object-fit: cover; }
        #reader__dashboard, #reader__status_span, #reader button,
        #reader select, #reader__header_message { display: none !important; }
        .scanner-laser {
            position: absolute; left: 10%; width: 80%; height: 2px;
            background: red; box-shadow: 0 0 8px red; z-index: 9;
            animation: laserSweep 1.6s infinite ease-in-out; pointer-events: none;
        }
        @keyframes laserSweep { 0%,100%{top:40px} 50%{top:180px} }

        /* â”€â”€ PRODUCT CARDS â”€â”€ */
        #resultsArea { display: grid; grid-template-columns: 1fr; gap: 14px; margin-top: 25px; }
        @media(min-width: 600px) { #resultsArea { grid-template-columns: repeat(2, 1fr); } }
        @media(min-width: 900px) { #resultsArea { grid-template-columns: repeat(3, 1fr); } }

        .product-card {
            background: #fff; border-radius: 20px; overflow: hidden;
            box-shadow: 0 3px 12px rgba(0,0,0,0.07); border: 1.5px solid #eee;
            display: flex; flex-direction: column; cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
            animation: fadeUp 0.3s ease both;
        }
        .product-card:active { transform: scale(0.98); }
        @keyframes fadeUp { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:none} }

        /* FIX: hidden when broken, not showing broken-image icon */
        .product-img {
            width: 100%; height: 240px; object-fit: contain;
            background: #fff; padding: 15px; border-bottom: 1px solid #f2f2f2;
        }
        .product-no-img {
            height: 240px; background: #f5f5f5; border-bottom: 1px solid #f2f2f2;
            display: flex; align-items: center; justify-content: center;
            color: #ddd; font-size: 48px;
        }
        .product-info-wrapper { padding: 15px 18px; flex-grow: 1; }
        .product-code-label { font-size: 11px; color: var(--accent); font-weight: 800; text-transform: uppercase; margin: 0; }
        .product-name-label { font-size: 15px; font-weight: 800; color: #000; margin: 4px 0 0; }

        /* â”€â”€ PRODUCT MODAL (bottom sheet) â”€â”€ */
        /* FIX: #productModal had ZERO CSS â€” completely invisible before */
        #productModal {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.75); z-index: 12500;
            align-items: flex-end; justify-content: center;
        }
        #productModal.open { display: flex; }
        #productModalBox {
            position: relative; background: #fff; width: 100%; max-width: 600px;
            border-radius: 28px 28px 0 0; max-height: 92vh; overflow-y: auto;
            animation: slideUp 0.28s ease;
        }
        @keyframes slideUp { from{transform:translateY(60px);opacity:0} to{transform:none;opacity:1} }
        .pm-close-btn {
            position: absolute; top: 14px; right: 16px; font-size: 30px;
            cursor: pointer; z-index: 10; background: rgba(0,0,0,0.08);
            border: none; border-radius: 50%; width: 38px; height: 38px;
            display: flex; align-items: center; justify-content: center; line-height: 1;
        }
        #productModalImg { width: 100%; height: 320px; object-fit: contain; background: #fff; padding: 15px; border-radius: 28px 28px 0 0; }
        .pm-body { padding: 20px; }
        .pm-code  { color: var(--accent); font-weight: 800; font-size: 12px; text-transform: uppercase; }
        .pm-name  { font-size: 22px; font-weight: 800; margin: 4px 0 2px; }
        .pm-ean   { font-size: 12px; color: #aaa; }
        .pm-desc  { font-size: 14px; color: #666; margin: 10px 0; line-height: 1.5; }
        .pm-price { font-size: 28px; font-weight: 900; color: #000; margin-bottom: 20px; }
        .pm-sizes-title { font-size: 12px; font-weight: 700; color: #888; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; }

        .size-grid { display: flex; flex-direction: column; gap: 8px; }
        .size-btn-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 14px; background: #f9f9f9; border-radius: 12px; border: 1.5px solid #eee;
        }
        .size-btn-row.has-qty { border-color: var(--accent); background: #f0faff; }
        .pm-qty-ctrl { display: flex; align-items: center; gap: 8px; }
        .pm-btn-qty {
            width: 34px; height: 34px; border-radius: 10px; border: none;
            background: #fff; font-weight: 800; font-size: 18px; cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center;
        }
        .pm-qty-inp {
            width: 48px; text-align: center; border: 1.5px solid #ddd;
            border-radius: 10px; height: 34px; font-weight: 800; font-size: 16px;
            font-family: 'Inter'; outline: none;
        }
        .pm-add-btn {
            width: 100%; background: #000; color: #fff; border: none;
            padding: 18px; border-radius: 15px; font-weight: 800; font-size: 16px;
            margin-top: 20px; cursor: pointer; letter-spacing: 0.3px;
        }

        /* â”€â”€ CART SUMMARY BAR â”€â”€ */
        #cartSummaryBar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: #000; color: #fff; padding: 15px 20px;
            display: none; align-items: center; justify-content: space-between;
            z-index: 9000; border-top: 3px solid var(--accent); cursor: pointer;
        }
        #cartSummaryBar.active { display: flex; }

        /* â”€â”€ CART GROUPS â”€â”€ */
        .cart-group { border: 1.5px solid #eee; border-radius: 18px; margin-bottom: 16px; overflow: hidden; background: #fff; }
        .cart-group-header { background: #fcfcfc; padding: 14px; border-bottom: 1px solid #f5f5f5; display: flex; gap: 12px; align-items: center; }
        .cart-thumb { width: 70px; height: 70px; border-radius: 10px; object-fit: contain; border: 1px solid #eee; background: #fff; flex-shrink: 0; }
        .cart-size-row { display: flex; justify-content: space-between; padding: 12px 14px; border-bottom: 1px solid #f9f9f9; align-items: center; }
        .cart-qty-ctrl { display: flex; align-items: center; gap: 8px; background: #f0f0f0; border-radius: 10px; padding: 4px 8px; }
        .cart-btn-qty { width: 30px; height: 30px; border-radius: 8px; border: none; background: #fff; font-weight: 800; font-size: 16px; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .cart-qty-display { font-weight: 800; font-size: 16px; min-width: 28px; text-align: center; }

        /* â”€â”€ MODALS â”€â”€ */
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 12000; }
        .modal-content { background: #fff; margin: 3% auto; width: 95%; max-width: 560px; padding: 25px; border-radius: 24px; max-height: 90vh; overflow-y: auto; }

        /* â”€â”€ HISTORY â”€â”€ */
        .hist-item { padding: 14px; background: #f9f9f9; border-radius: 14px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        .hist-item-info { font-size: 13px; }
        .hist-item-info b { display: block; margin-bottom: 2px; }
        .hist-item-info small { color: #aaa; }
        .btn-hist-excel { background: #2ecc71; border: none; color: #fff; padding: 8px 14px; border-radius: 9px; font-weight: 700; cursor: pointer; white-space: nowrap; flex-shrink: 0; }

        /* â”€â”€ TOAST â”€â”€ */
        #toast {
            visibility: hidden; min-width: 240px; background: #000; color: #fff;
            text-align: center; border-radius: 50px; padding: 14px 22px;
            position: fixed; z-index: 20000; left: 50%; bottom: 130px;
            transform: translateX(-50%); font-weight: 600; font-size: 14px;
            transition: opacity 0.3s;
        }
        #toast.show { visibility: visible; }
    </style>
</head>
<body>

<div id="debugStatus">â³ Veriler YÃ¼kleniyor...</div>

<!-- LOGIN -->
<div id="loginOverlay">
    <div class="login-box">
        <h2 style="margin:0;font-weight:800;">AS SPOR</h2>
        <p style="color:#666;font-size:13px;margin-bottom:20px;">Showroom Personel GiriÅŸi</p>
        <!-- FIX: added Enter key support via id-based listeners in JS -->
        <input type="text"     id="loginUser" class="login-input" placeholder="KullanÄ±cÄ± AdÄ±"
               autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false">
        <input type="password" id="loginPass" class="login-input" placeholder="Åifre"
               autocomplete="current-password">
        <button onclick="checkLogin()" class="login-btn">GÄ°RÄ°Å YAP</button>
        <div id="loginError"></div>
    </div>
</div>

<!-- HEADER -->
<div class="header-hero"><div class="main-container"><h1 style="margin:0;">AS SPOR</h1></div></div>

<div class="main-container">
    <div class="user-welcome-bar">
        <div><b>Sorumlu:</b> <span id="displayUserName">-</span></div>
        <div style="display:flex;gap:10px;">
            <button onclick="openHistory()" style="background:#eee;border:none;padding:8px 12px;border-radius:8px;font-weight:600;cursor:pointer;font-size:12px;">
                <i class="fas fa-history"></i> GeÃ§miÅŸ
            </button>
            <button onclick="logout()" style="color:red;border:none;background:none;cursor:pointer;font-weight:700;">Ã‡IKIÅ</button>
        </div>
    </div>

    <input type="text" id="dealerName" class="login-input"
           style="margin-top:15px;background:#fff;" placeholder="Bayi AdÄ± (Zorunlu)"
           oninput="persistDealer()" autocomplete="off">

    <div class="search-container">
        <input type="text" id="searchInput" class="search-field" placeholder="ÃœrÃ¼n Kodu, Ä°sim veya Barkod Ara..." autocomplete="off">
        <button class="btn-scan"   onclick="searchProduct()"><i class="fas fa-search"></i></button>
        <button class="btn-camera" onclick="toggleCamera()"><i class="fas fa-camera"></i></button>
    </div>

    <!-- SCANNER -->
    <div id="reader-container">
        <div id="reader-viewport">
            <div id="reader"></div>
            <div class="scanner-laser"></div>
        </div>
        <button onclick="toggleCamera()"
            style="width:100%;background:#222;color:#ccc;border:none;padding:15px;font-weight:700;cursor:pointer;">
            <i class="fas fa-times"></i> KAPAT
        </button>
    </div>

    <div id="resultsArea"></div>
</div>

<!-- CART SUMMARY BAR -->
<div id="cartSummaryBar" onclick="openCart()">
    <div>
        <span id="st-qty" style="font-weight:800;font-size:18px;">0</span>
        <span style="font-size:14px;opacity:0.8;"> ADET</span>
    </div>
    <div style="text-align:right;">
        <div style="font-size:11px;opacity:0.6;text-transform:uppercase;letter-spacing:0.5px;">Toplam Tutar</div>
        <div id="st-total" style="font-weight:900;font-size:20px;color:var(--accent);">0.00 TL</div>
    </div>
</div>

<!-- CART MODAL -->
<div id="cartModal" class="modal">
    <div class="modal-content">
        <span onclick="closeModal('cartModal')" style="float:right;cursor:pointer;font-size:28px;">&times;</span>
        <h2 style="margin:0 0 6px;font-weight:800;">Sepetim</h2>
        <p id="cartSummaryLine" style="margin:0 0 18px;color:#aaa;font-size:13px;"></p>
        <div id="cartItems"></div>
        <div style="margin-top:20px;text-align:right;font-size:20px;font-weight:800;">
            TOPLAM: <span id="cartTotal" style="color:var(--accent);">0.00</span>
        </div>
        <button id="btnConfirmOrder" onclick="confirmAndLockOrder()"
            style="width:100%;background:#000;color:#fff;padding:18px;border-radius:15px;font-weight:800;margin-top:20px;border:none;cursor:pointer;font-size:15px;">
            SÄ°PARÄ°ÅÄ° ONAYLA
        </button>
        <div id="postConfirmActions" style="display:none;flex-direction:column;gap:10px;margin-top:15px;">
            <input type="email" id="customerEmail" class="login-input" placeholder="MÃ¼ÅŸteri Maili (Opsiyonel)">
            <div style="display:flex;gap:12px;">
                <button onclick="saveAndExport()" style="flex:1;background:#2ecc71;color:#fff;border:none;padding:15px;border-radius:12px;font-weight:800;cursor:pointer;">
                    <i class="fas fa-file-excel"></i> EXCEL
                </button>
                <button onclick="sendMail()" id="btnMail" style="flex:1;background:#000;color:#fff;border:none;padding:15px;border-radius:12px;font-weight:800;cursor:pointer;">
                    <i class="fas fa-paper-plane"></i> MAÄ°L AT
                </button>
            </div>
            <button onclick="confirmClearCart()" style="width:100%;background:#fff;color:red;border:2px solid red;padding:15px;border-radius:12px;font-weight:800;cursor:pointer;margin-top:10px;">
                SEPETÄ° TEMÄ°ZLE
            </button>
        </div>
    </div>
</div>

<!-- HISTORY MODAL -->
<div id="historyModal" class="modal">
    <div class="modal-content">
        <span onclick="closeModal('historyModal')" style="float:right;cursor:pointer;font-size:28px;">&times;</span>
        <h2 style="font-weight:800;margin:0 0 16px;">SipariÅŸ GeÃ§miÅŸi</h2>
        <div id="historyList"></div>
    </div>
</div>

<!-- PRODUCT DETAIL MODAL (bottom sheet) -->
<!-- FIX: productModal was entirely missing its CSS â€” now defined above -->
<div id="productModal">
    <div id="productModalBox">
        <button class="pm-close-btn" onclick="_closeProductModal()">&times;</button>
        <img id="productModalImg" src="" alt="">
        <div class="pm-body">
            <div class="pm-code"  id="pm-code"></div>
            <div class="pm-name"  id="pm-name"></div>
            <div class="pm-ean"   id="pm-ean"></div>
            <div class="pm-desc"  id="pm-desc"></div>
            <div class="pm-price" id="pm-price"></div>
            <div class="pm-sizes-title">Beden SeÃ§in &amp; Adet Girin</div>
            <div id="pm-sizes" class="size-grid"></div>
            <button class="pm-add-btn" onclick="addToCartFromModal()">
                <i class="fas fa-shopping-basket"></i>&nbsp; SEPETE EKLE
            </button>
        </div>
    </div>
</div>

<div id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 1. CONSTANTS & USERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const EMAILJS_SVC = "service_qh7mngr";
const EMAILJS_TMP = "template_2e5jxvh";
const EMAILJS_KEY = "VSRTcl2JLxhmNWT4a";
const FIXED_EMAILS = "emel@asspor.com, siparis@asspor.com";

const USERS = {
    "adnankaya":   { name: "Adnan Kaya",   pass: "1234" },
    "cinargokce":  { name: "Ã‡Ä±nar GÃ¶kÃ§e",  pass: "1234" },
    "lutfuozturk": { name: "LÃ¼tfÃ¼ Ã–ztÃ¼rk", pass: "1234" },
    "meftunicay":  { name: "Meftuni Ã‡ay",  pass: "1234" },
    "muratturgut": { name: "Murat Turgut", pass: "1234" },
    "ozkanocak":   { name: "Ã–zkan Ocak",   pass: "1234" },
    "serkanmert":  { name: "Serkan Mert",  pass: "1234" },
    "admin":       { name: "Test Admin",   pass: "1234" }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 2. STATE â€” all declared ONCE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let inventory     = [];
let cart          = [];
let currentU      = null;
let html5QrCode   = null;
let cameraRunning = false;
let modalCode     = null;
let groupedResults = {};

const beep = new Audio("https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3");

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 3. INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('load', function() {
    emailjs.init(EMAILJS_KEY);

    // FIX: Enter key support on login
    document.getElementById('loginUser').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') document.getElementById('loginPass').focus();
    });
    document.getElementById('loginPass').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') checkLogin();
    });
    // Enter key on search
    document.getElementById('searchInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') searchProduct();
    });

    // FIX: backdrop click on productModal
    document.getElementById('productModal').addEventListener('click', function(e) {
        if (e.target === this) _closeProductModal();
    });

    // FIX: session restore â€” ONLY restore if token matches, never trust username alone
    var savedUser  = localStorage.getItem('as_active_user');
    var savedToken = localStorage.getItem('as_token');
    if (savedUser && USERS[savedUser] && savedToken === _makeToken(savedUser, USERS[savedUser].pass)) {
        loginSuccess(savedUser);
    } else {
        // Wipe any stale session data
        localStorage.removeItem('as_active_user');
        localStorage.removeItem('as_token');
    }

    loadInventory();
});

// FIX: simple session token â€” prevents username-only auto-login bypass
function _makeToken(u, p) { return btoa(u + ':' + p); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 4. DATA LOADING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadInventory() {
    var bar = document.getElementById('debugStatus');
    Papa.parse('data.csv', {
        download: true, header: true, delimiter: ";", skipEmptyLines: 'greedy',
        complete: function(r) {
            inventory = r.data.filter(function(row) {
                return row['Product'] || row['Reference'] || row['EAN'];
            });
            bar.style.background = '#27ae60';
            bar.innerText = 'âœ… ' + inventory.length.toLocaleString('tr-TR') + ' Ã¼rÃ¼n yÃ¼klendi';
            setTimeout(function() { bar.style.display = 'none'; }, 3000);
        },
        error: function(err) {
            bar.style.background = '#e74c3c';
            bar.innerText = 'âŒ Veri yÃ¼klenemedi! data.csv kontrol edin.';
            console.error('CSV error:', err);
        }
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 5. AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function checkLogin() {
    var errEl = document.getElementById('loginError');
    errEl.style.display = 'none';
    var u = document.getElementById('loginUser').value.trim().toLowerCase().replace(/\s/g, '');
    var p = document.getElementById('loginPass').value;

    if (!u || !p) {
        errEl.innerText = 'KullanÄ±cÄ± adÄ± ve ÅŸifre giriniz!';
        errEl.style.display = 'block';
        return;
    }
    if (USERS[u] && USERS[u].pass === p) {
        localStorage.setItem('as_active_user', u);
        localStorage.setItem('as_token', _makeToken(u, p));
        loginSuccess(u);
    } else {
        errEl.innerText = 'KullanÄ±cÄ± adÄ± veya ÅŸifre hatalÄ±!';
        errEl.style.display = 'block';
        document.getElementById('loginPass').value = '';
    }
}

function loginSuccess(u) {
    currentU = u;
    document.getElementById('displayUserName').innerText = USERS[u].name;
    document.getElementById('loginOverlay').style.display = 'none';

    // Restore cart
    try {
        var savedCart = localStorage.getItem('as_cart_' + u);
        cart = savedCart ? JSON.parse(savedCart) : [];
    } catch(e) { cart = []; }

    // Restore dealer name
    var savedDealer = localStorage.getItem('as_dealer_' + u);
    document.getElementById('dealerName').value = savedDealer || '';

    updateCartUI();
}

function persistCart() {
    if (currentU) {
        try { localStorage.setItem('as_cart_' + currentU, JSON.stringify(cart)); }
        catch(e) { console.warn('Cart persist failed:', e); }
    }
}
function persistDealer() {
    if (currentU) localStorage.setItem('as_dealer_' + currentU, document.getElementById('dealerName').value);
}

function logout() {
    localStorage.removeItem('as_active_user');
    localStorage.removeItem('as_token');
    // FIX: stop camera on logout if it's running
    if (cameraRunning && html5QrCode) {
        html5QrCode.stop().catch(function(){}).finally(function() { location.reload(); });
    } else {
        location.reload();
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 6. SEARCH & RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function searchProduct() {
    var q = document.getElementById('searchInput').value.toUpperCase().trim();
    if (!q) return;
    if (inventory.length === 0) return showToast("Veriler henÃ¼z yÃ¼klenmedi, bekleyin.");

    var matches = inventory.filter(function(i) {
        return (i['Product']     || '').toUpperCase().includes(q) ||
               (i['Description'] || '').toUpperCase().includes(q) ||
               (i['EAN']         || '').includes(q);
    });
    if (matches.length === 0) return showToast("BulunamadÄ±: " + q);

    groupedResults = {};
    matches.forEach(function(item) {
        var c = item['Product'] || item['Reference'] || '?';
        if (!groupedResults[c]) groupedResults[c] = [];
        groupedResults[c].push(item);
    });

    renderResults();
    // FIX: clear search input so pressing Enter again doesn't duplicate results
    document.getElementById('searchInput').value = '';
    setTimeout(function() {
        document.getElementById('resultsArea').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 60);
}

function escHtml(s) {
    return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function renderResults() {
    var area = document.getElementById('resultsArea');
    area.innerHTML = '';

    Object.keys(groupedResults).forEach(function(code, i) {
        var g = groupedResults[code];
        var f = g[0];
        var desc = f['Description'] || f['description'] || '';
        var price = f['Tariff Price'] || '';
        var currency = f['Currency'] || '';

        var card = document.createElement('div');
        card.className = 'product-card';
        card.style.animationDelay = (i * 0.04) + 's';
        card.onclick = function() { openProductModal(code); };

        // FIX: use onerror to hide broken image instead of showing placeholder icon
        var imgHtml = f['ImageURL']
            ? '<img src="' + escHtml(f['ImageURL']) + '" class="product-img" onerror="this.parentNode.replaceChild(Object.assign(document.createElement(\'div\'), {className:\'product-no-img\',innerHTML:\'<i class=\\\"fas fa-tshirt\\\"></i>\'}), this)" alt="">'
            : '<div class="product-no-img"><i class="fas fa-tshirt"></i></div>';

        card.innerHTML = imgHtml + '<div class="product-info-wrapper">'
            + '<p class="product-code-label">' + escHtml(code) + '</p>'
            + '<p class="product-name-label">' + escHtml(desc) + '</p>'
            + '<p style="font-size:10px;color:#bbb;margin:4px 0 0;">EAN: ' + escHtml(f['EAN'] || '-') + '</p>'
            + '<span style="font-size:18px;font-weight:900;color:#000;margin-top:10px;display:block;">'
            + escHtml(price) + ' ' + escHtml(currency) + '</span>'
            + '</div>';

        area.appendChild(card);
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 7. PRODUCT MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openProductModal(code) {
    var g = groupedResults[code];
    if (!g || !g.length) return;
    var f = g[0];
    modalCode = code;

    var imgEl = document.getElementById('productModalImg');
    imgEl.src = f['ImageURL'] || '';
    imgEl.style.display = f['ImageURL'] ? 'block' : 'none';

    document.getElementById('pm-code').innerText  = code;
    document.getElementById('pm-name').innerText  = f['Description'] || '';
    document.getElementById('pm-ean').innerText   = f['EAN'] ? 'EAN: ' + f['EAN'] : '';
    document.getElementById('pm-desc').innerText  = f['Long Description'] || '';
    document.getElementById('pm-price').innerText = (f['Tariff Price'] || '-') + ' ' + (f['Currency'] || '');

    // FIX: reset all qty inputs to 0 when modal opens â€” no stale values from previous open
    document.getElementById('pm-sizes').innerHTML = g.map(function(item, idx) {
        var stock = parseInt(item['Stock Quantity']) || 0;
        var alreadyInCart = 0;
        cart.forEach(function(c) {
            if (c['Product'] === item['Product'] && c['EUR Size'] === item['EUR Size']) alreadyInCart = c.qty;
        });
        return '<div class="size-btn-row' + (alreadyInCart > 0 ? ' has-qty' : '') + '" id="sizerow-' + idx + '">'
            + '<div><span style="font-weight:800;font-size:15px;">' + escHtml(item['EUR Size'] || '-') + '</span>'
            + '<br><small style="color:#888;font-size:11px;">Stok: ' + stock + (alreadyInCart > 0 ? ' Â· Sepette: ' + alreadyInCart : '') + '</small></div>'
            + '<div class="pm-qty-ctrl">'
            + '<button class="pm-btn-qty" onclick="pmQty(' + idx + ',-1)">âˆ’</button>'
            + '<input type="number" id="pm-qty-' + idx + '" class="pm-qty-inp" value="0" min="0" max="' + (stock || 999) + '">'
            + '<button class="pm-btn-qty" onclick="pmQty(' + idx + ',1,' + (stock || 999) + ')">+</button>'
            + '</div></div>';
    }).join('');

    document.getElementById('productModal').classList.add('open');
    document.body.style.overflow = 'hidden';
}

function pmQty(idx, delta, max) {
    var el = document.getElementById('pm-qty-' + idx);
    if (!el) return;
    var v = parseInt(el.value || 0) + delta;
    v = Math.max(0, max !== undefined ? Math.min(v, max) : v);
    el.value = v;
    // Highlight row if qty > 0
    var row = document.getElementById('sizerow-' + idx);
    if (row) row.className = 'size-btn-row' + (v > 0 ? ' has-qty' : '');
}

function _closeProductModal() {
    document.getElementById('productModal').classList.remove('open');
    document.body.style.overflow = '';
    modalCode = null;
}

function addToCartFromModal() {
    var d = document.getElementById('dealerName').value.trim();
    if (!d) return showToast("âš ï¸ Ã–nce Bayi AdÄ± Girin!");
    var g = groupedResults[modalCode];
    if (!g) return;

    var added = 0;
    g.forEach(function(item, idx) {
        var el = document.getElementById('pm-qty-' + idx);
        var q = parseInt(el ? el.value : 0) || 0;
        if (q > 0) {
            // FIX: merge into existing cart entry if same product+size
            var exist = cart.find(function(x) {
                return x['Product'] === item['Product'] && x['EUR Size'] === item['EUR Size'];
            });
            if (exist) { exist.qty += q; }
            else {
                cart.push(Object.assign({}, item, {
                    qty: q,
                    price: parseFloat(item['Tariff Price']) || 0,
                    dealer: d
                }));
            }
            added += q;
        }
    });

    if (added > 0) {
        persistCart();
        updateCartUI();
        // Reset confirm/post-confirm state
        document.getElementById('btnConfirmOrder').style.display = 'block';
        document.getElementById('postConfirmActions').style.display = 'none';
        showToast('âœ… ' + added + ' adet eklendi.');
        _closeProductModal();
    } else {
        showToast("LÃ¼tfen en az bir beden iÃ§in adet girin.");
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 8. CART UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Stable key so we never use fragile array indices
function cartKey(item) {
    return (item['Product'] || '') + '||' + (item['EUR Size'] || '');
}

function updateCartUI() {
    var count   = cart.reduce(function(a, b) { return a + b.qty; }, 0);
    var total   = cart.reduce(function(a, b) { return a + b.price * b.qty; }, 0);
    var currency = (cart.length > 0 && cart[0]['Currency']) ? cart[0]['Currency'] : 'TL';
    var totalStr = total.toFixed(2) + ' ' + currency;

    document.getElementById('cartTotal').innerText     = totalStr;
    document.getElementById('st-qty').innerText        = count;
    document.getElementById('st-total').innerText      = totalStr;
    document.getElementById('cartSummaryLine').innerText =
        count > 0 ? count + ' adet Â· ' + cart.length + ' kalem' : '';

    var bar = document.getElementById('cartSummaryBar');
    if (count > 0) bar.classList.add('active');
    else bar.classList.remove('active');

    // If cart modal is open, re-render it in-place
    if (document.getElementById('cartModal').style.display === 'block') {
        _renderCartItems();
    }
}

function openCart() {
    _renderCartItems();
    document.getElementById('cartModal').style.display = 'block';
}

function _renderCartItems() {
    var list = document.getElementById('cartItems');
    if (cart.length === 0) {
        list.innerHTML = "<p style='text-align:center;padding:30px 0;color:#bbb;'>Sepet boÅŸ.</p>";
        return;
    }

    // Group by product code (maintain insertion order)
    var groupOrder = [];
    var groups = {};
    cart.forEach(function(item) {
        var code = item['Product'] || item['Reference'] || '?';
        if (!groups[code]) {
            groups[code] = { name: item['Description'] || '', img: item['ImageURL'] || '', items: [], subTotal: 0, subQty: 0 };
            groupOrder.push(code);
        }
        groups[code].items.push(item);
        groups[code].subTotal += item.price * item.qty;
        groups[code].subQty   += item.qty;
    });

    var currency = (cart.length > 0 && cart[0]['Currency']) ? cart[0]['Currency'] : 'TL';

    list.innerHTML = groupOrder.map(function(code) {
        var g = groups[code];
        return '<div class="cart-group">'
            + '<div class="cart-group-header">'
            + '<img src="' + escHtml(g.img) + '" class="cart-thumb" onerror="this.style.display=\'none\'" alt="">'
            + '<div style="flex:1">'
            + '<div style="font-size:11px;font-weight:800;color:var(--accent);">' + escHtml(code) + '</div>'
            + '<div style="font-weight:800;font-size:14px;">' + escHtml(g.name) + '</div>'
            + '<div style="font-size:12px;color:#555;margin-top:4px;"><b>' + g.subQty + ' ADET</b> â€” ' + g.subTotal.toFixed(2) + ' ' + escHtml(currency) + '</div>'
            + '</div></div>'
            + g.items.map(function(item) {
                var key = encodeURIComponent(cartKey(item));
                return '<div class="cart-size-row">'
                    + '<span style="font-weight:700;">Beden: ' + escHtml(item['EUR Size'] || '-') + ' <small style="color:#aaa;font-weight:400;">(Stok: ' + (item['Stock Quantity'] || 0) + ')</small></span>'
                    // FIX: cart qty changed with buttons only â€” no freeform input that loses focus on re-render
                    + '<div class="cart-qty-ctrl">'
                    + '<button class="cart-btn-qty" onclick="cartChangeQty(\'' + key + '\',-1)">âˆ’</button>'
                    + '<span class="cart-qty-display">' + item.qty + '</span>'
                    + '<button class="cart-btn-qty" onclick="cartChangeQty(\'' + key + '\',1)">+</button>'
                    + '</div></div>';
            }).join('')
            + '</div>';
    }).join('');
}

// FIX: use stable key â€” never fragile array index
function cartChangeQty(encodedKey, delta) {
    var key = decodeURIComponent(encodedKey);
    var item = cart.find(function(c) { return cartKey(c) === key; });
    if (!item) return;
    item.qty = Math.max(0, item.qty + delta);
    if (item.qty === 0) cart = cart.filter(function(c) { return cartKey(c) !== key; });
    persistCart();
    updateCartUI();
}

function confirmAndLockOrder() {
    if (cart.length === 0) return showToast("Sepet boÅŸ!");
    var d = document.getElementById('dealerName').value.trim();
    if (!d) return showToast("âš ï¸ Bayi adÄ± giriniz!");
    document.getElementById('btnConfirmOrder').style.display = 'none';
    document.getElementById('postConfirmActions').style.display = 'flex';
    showToast("âœ“ SipariÅŸ OnaylandÄ±.");
}

function confirmClearCart() {
    if (confirm("TÃ¼m sepeti temizleyip yeni satÄ±ÅŸa baÅŸlamak istiyor musunuz?")) {
        cart = [];
        persistCart();
        updateCartUI();
        closeModal('cartModal');
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 9. EXCEL EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveAndExport() {
    if (cart.length === 0) return showToast("Sepet boÅŸ!");
    var dealer = document.getElementById('dealerName').value.trim() || 'siparis';
    // FIX: export clean column set â€” not raw internal cart object
    var rows = cart.map(function(i) {
        return {
            'ÃœrÃ¼n Kodu':   i['Product']     || '',
            'AÃ§Ä±klama':    i['Description'] || '',
            'Beden':       i['EUR Size']    || '',
            'Adet':        i.qty,
            'Birim Fiyat': i.price,
            'Toplam':      (i.price * i.qty).toFixed(2),
            'Para Birimi': i['Currency']    || '',
            'Bayi':        i.dealer         || ''
        };
    });
    saveToHistory(cart, dealer);
    var ws = XLSX.utils.json_to_sheet(rows);
    var wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Siparis");
    XLSX.writeFile(wb, 'AsSpor_' + dealer + '_' + new Date().toISOString().slice(0,10) + '.xlsx');
    showToast("âœ… Excel indirildi.");
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 10. EMAIL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function sendMail() {
    if (cart.length === 0) return showToast("Sepet boÅŸ!");
    var dealer = document.getElementById('dealerName').value.trim();
    if (!dealer) return showToast("âš ï¸ Bayi adÄ± giriniz!");

    var btn = document.getElementById('btnMail');
    btn.disabled = true; btn.innerText = "GÃ–NDERÄ°LÄ°YOR...";

    var table = '<table border="1" style="border-collapse:collapse;width:100%;font-family:Arial;font-size:13px;">'
        + '<tr style="background:#000;color:#fff;"><th>Kod</th><th>ÃœrÃ¼n</th><th>Beden</th><th>Adet</th><th>Tutar</th></tr>';
    cart.forEach(function(i) {
        table += '<tr><td>' + escHtml(i['Product']) + '</td><td>' + escHtml(i['Description']) + '</td>'
            + '<td>' + escHtml(i['EUR Size']) + '</td><td>' + i.qty + '</td>'
            + '<td>' + (i.price * i.qty).toFixed(2) + ' ' + escHtml(i['Currency'] || '') + '</td></tr>';
    });
    table += '</table>';

    var extra = document.getElementById('customerEmail').value.trim();
    emailjs.send(EMAILJS_SVC, EMAILJS_TMP, {
        manager:        USERS[currentU].name,
        dealer:         dealer,
        order_details:  table,
        total_qty:      cart.reduce(function(s, i) { return s + i.qty; }, 0),
        customer_email: FIXED_EMAILS + (extra ? ', ' + extra : '')
    })
    .then(function() {
        // FIX: save to history after successful mail send
        saveToHistory(cart, dealer);
        showToast("âœ… SipariÅŸ Maili GÃ¶nderildi!");
    })
    .catch(function(err) {
        console.error('EmailJS error:', err);
        showToast("âŒ Mail gÃ¶nderilemedi. Tekrar deneyin.");
    })
    .finally(function() { btn.disabled = false; btn.innerText = "MAÄ°L AT"; });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 11. ORDER HISTORY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveToHistory(items, dealer) {
    try {
        var h = JSON.parse(localStorage.getItem('as_history') || '[]');
        h.unshift({ id: Date.now(), date: new Date().toLocaleString('tr-TR'), dealer: dealer, items: items });
        localStorage.setItem('as_history', JSON.stringify(h.slice(0, 50)));
    } catch(e) { console.warn('History save failed:', e); }
}

// FIX: openHistory was just an alert stub â€” now fully functional
function openHistory() {
    var h = [];
    try { h = JSON.parse(localStorage.getItem('as_history') || '[]'); } catch(e) {}
    var list = document.getElementById('historyList');
    if (h.length === 0) {
        list.innerHTML = '<p style="text-align:center;color:#bbb;padding:20px;">GeÃ§miÅŸ yok.</p>';
    } else {
        list.innerHTML = h.map(function(o) {
            var totalQty = o.items.reduce(function(s, i) { return s + i.qty; }, 0);
            return '<div class="hist-item">'
                + '<div class="hist-item-info">'
                + '<b>' + escHtml(o.dealer) + '</b>'
                + '<small>' + o.date + ' Â· ' + totalQty + ' adet Â· ' + o.items.length + ' kalem</small>'
                + '</div>'
                + '<button class="btn-hist-excel" onclick="downloadHistItem(' + o.id + ')">Excel</button>'
                + '</div>';
        }).join('');
    }
    document.getElementById('historyModal').style.display = 'block';
}

function downloadHistItem(id) {
    try {
        var h   = JSON.parse(localStorage.getItem('as_history') || '[]');
        var rec = h.find(function(o) { return o.id === id; });
        if (!rec) return showToast("KayÄ±t bulunamadÄ±.");
        var rows = rec.items.map(function(i) {
            return {
                'ÃœrÃ¼n Kodu':   i['Product']     || '',
                'AÃ§Ä±klama':    i['Description'] || '',
                'Beden':       i['EUR Size']    || '',
                'Adet':        i.qty,
                'Birim Fiyat': i.price,
                'Toplam':      (i.price * i.qty).toFixed(2),
                'Para Birimi': i['Currency']    || '',
                'Bayi':        i.dealer         || rec.dealer
            };
        });
        var ws = XLSX.utils.json_to_sheet(rows);
        var wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Siparis");
        XLSX.writeFile(wb, 'Gecmis_' + rec.dealer + '_' + rec.id + '.xlsx');
    } catch(e) { showToast("Ä°ndirme hatasÄ±."); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 12. CAMERA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIX: toggleCamera was not awaiting stop() â€” race condition caused camera LED to stay on
window.toggleCamera = async function() {
    var container = document.getElementById('reader-container');
    if (cameraRunning && html5QrCode) {
        try { await html5QrCode.stop(); html5QrCode.clear(); } catch(e) { console.warn(e); }
        html5QrCode   = null;
        cameraRunning = false;
        container.style.display = 'none';
        return;
    }
    container.style.display = 'block';
    html5QrCode = new Html5Qrcode("reader");
    var config = {
        fps: 20,
        qrbox: { width: 250, height: 100 },
        formatsToSupport: [
            Html5QrcodeSupportedFormats.EAN_13, Html5QrcodeSupportedFormats.EAN_8,
            Html5QrcodeSupportedFormats.CODE_128, Html5QrcodeSupportedFormats.CODE_39,
            Html5QrcodeSupportedFormats.QR_CODE
        ]
    };
    try {
        await html5QrCode.start({ facingMode: "environment" }, config,
            async function(decodedText) {
                beep.play().catch(function(){});
                document.getElementById('searchInput').value = decodedText;
                searchProduct();
                showToast("ğŸ“¸ " + decodedText);
                // Stop camera after successful scan
                if (cameraRunning) {
                    try { await html5QrCode.stop(); html5QrCode.clear(); } catch(e) {}
                    html5QrCode   = null;
                    cameraRunning = false;
                    container.style.display = 'none';
                }
            },
            function() {}
        );
        cameraRunning = true;
    } catch(err) {
        showToast("Kamera aÃ§Ä±lamadÄ± â€” izin verin.");
        console.error('Camera error:', err);
        html5QrCode   = null;
        cameraRunning = false;
        container.style.display = 'none';
    }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 13. UTILITIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function closeModal(id) {
    document.getElementById(id).style.display = 'none';
}

function showToast(msg) {
    var t = document.getElementById('toast');
    t.innerText = msg;
    t.className = 'show';
    clearTimeout(t._timer);
    t._timer = setTimeout(function() { t.className = ''; }, 3000);
}
</script>
</body>
</html>
